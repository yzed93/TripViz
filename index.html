<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TripViz - Japan Reiseplaner</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.ico">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet AntPath -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    <!-- SortableJS f√ºr Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Default Theme: Cyberpunk Dark */
        :root {
            --bg-main: #0f0f0f; 
            --panel-bg: rgba(20, 20, 20, 0.98);
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-primary: #00f2ff; 
            --accent-secondary: #00ccff;
            --accent-transport: #ff2d55; 
            --accent-path: #3b82f6; 
            --text-main: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-on-accent: #0a0a0a; /* Text color on accent backgrounds */
            --gradient-primary: linear-gradient(135deg, #00f2ff 0%, #0099ff 100%);
            --gradient-card: linear-gradient(135deg, rgba(0,242,255,0.05) 0%, rgba(0,153,255,0.05) 100%);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* Theme: Sakura (Cherry Blossom) */
        .theme-sakura {
            --bg-main: #1a0f14;
            --panel-bg: rgba(26, 15, 20, 0.98);
            --border-color: rgba(255, 183, 197, 0.2);
            --accent-primary: #ffb7c5;
            --accent-secondary: #ffd1dc;
            --accent-transport: #ff69b4;
            --accent-path: #db7093;
            --text-main: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-on-accent: #1a0515;
            --gradient-primary: linear-gradient(135deg, #ffb7c5 0%, #ff69b4 100%);
            --gradient-card: linear-gradient(135deg, rgba(255,183,197,0.05) 0%, rgba(255,105,180,0.05) 100%);
        }

        /* Theme: Zen Garden */
        .theme-zen {
            --bg-main: #0a0e0d;
            --panel-bg: rgba(15, 20, 18, 0.98);
            --border-color: rgba(134, 239, 172, 0.2);
            --accent-primary: #86efac;
            --accent-secondary: #4ade80;
            --accent-transport: #34d399;
            --accent-path: #10b981;
            --text-main: #f0fdf4;
            --text-secondary: rgba(240, 253, 244, 0.7);
            --text-on-accent: #0a1f0f;
            --gradient-primary: linear-gradient(135deg, #86efac 0%, #34d399 100%);
            --gradient-card: linear-gradient(135deg, rgba(134,239,172,0.05) 0%, rgba(52,211,153,0.05) 100%);
        }

        /* Theme: Tokyo Neon (PRO) */
        .theme-neon {
            --bg-main: #050505;
            --panel-bg: rgba(10, 10, 10, 0.98);
            --border-color: rgba(255, 0, 255, 0.3);
            --accent-primary: #ff00ff;
            --accent-secondary: #00ffff;
            --accent-transport: #ffff00;
            --accent-path: #ff1493;
            --text-main: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-on-accent: #0a0a0a;
            --gradient-primary: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);
            --gradient-card: linear-gradient(135deg, rgba(255,0,255,0.1) 0%, rgba(0,255,255,0.1) 100%);
        }

        /* Theme: Fuji Sunset (PRO) */
        .theme-fuji {
            --bg-main: #1a0a0f;
            --panel-bg: rgba(26, 10, 15, 0.98);
            --border-color: rgba(251, 146, 60, 0.2);
            --accent-primary: #fb923c;
            --accent-secondary: #f97316;
            --accent-transport: #dc2626;
            --accent-path: #f59e0b;
            --text-main: #fef3c7;
            --text-secondary: rgba(254, 243, 199, 0.7);
            --text-on-accent: #1a0a05;
            --gradient-primary: linear-gradient(135deg, #fb923c 0%, #dc2626 100%);
            --gradient-card: linear-gradient(135deg, rgba(251,146,60,0.05) 0%, rgba(220,38,38,0.05) 100%);
        }

        /* Theme: Ocean Blue */
        .theme-ocean {
            --bg-main: #020617;
            --panel-bg: rgba(2, 6, 23, 0.98);
            --border-color: rgba(59, 130, 246, 0.2);
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --accent-transport: #2563eb;
            --accent-path: #0ea5e9;
            --text-main: #f0f9ff;
            --text-secondary: rgba(240, 249, 255, 0.7);
            --text-on-accent: #020817;
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%);
            --gradient-card: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(14,165,233,0.05) 100%);
        }

        /* Theme: Matcha */
        .theme-matcha {
            --bg-main: #0d1410;
            --panel-bg: rgba(13, 20, 16, 0.98);
            --border-color: rgba(132, 204, 22, 0.2);
            --accent-primary: #84cc16;
            --accent-secondary: #65a30d;
            --accent-transport: #a3e635;
            --accent-path: #4d7c0f;
            --text-main: #fefce8;
            --text-secondary: rgba(254, 252, 232, 0.7);
            --text-on-accent: #0f1a0a;
            --gradient-primary: linear-gradient(135deg, #84cc16 0%, #65a30d 100%);
            --gradient-card: linear-gradient(135deg, rgba(132,204,22,0.05) 0%, rgba(101,163,13,0.05) 100%);
        }

        /* Theme: Midnight Purple (PRO) */
        .theme-midnight {
            --bg-main: #0f0514;
            --panel-bg: rgba(15, 5, 20, 0.98);
            --border-color: rgba(168, 85, 247, 0.2);
            --accent-primary: #a855f7;
            --accent-secondary: #c084fc;
            --accent-transport: #e879f9;
            --accent-path: #8b5cf6;
            --text-main: #faf5ff;
            --text-secondary: rgba(250, 245, 255, 0.7);
            --text-on-accent: #1a0a20;
            --gradient-primary: linear-gradient(135deg, #a855f7 0%, #e879f9 100%);
            --gradient-card: linear-gradient(135deg, rgba(168,85,247,0.05) 0%, rgba(232,121,249,0.05) 100%);
        }

        /* Neon Glow Effect for Tokyo Neon Theme */
        .theme-neon button:hover,
        .theme-neon .btn:hover {
            box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        }

        /* Dynamic color classes using CSS variables */
        .bg-accent-primary {
            background-color: var(--accent-primary) !important;
        }
        
        .text-accent-primary {
            color: var(--accent-primary) !important;
        }
        
        .border-accent-primary {
            border-color: var(--accent-primary) !important;
        }
        
        .shadow-accent-primary {
            box-shadow: 0 10px 15px -3px rgba(0, 242, 255, 0.1), 
                        0 4px 6px -2px rgba(0, 242, 255, 0.05) !important;
        }

        /* Override Tailwind hardcoded colors */
        .bg-cyan-400,
        .hover\:bg-cyan-500:hover {
            background-color: var(--accent-primary) !important;
        }

        .text-cyan-400 {
            color: var(--accent-primary) !important;
        }

        .border-cyan-400 {
            border-color: var(--accent-primary) !important;
        }

        .shadow-cyan-400\/20 {
            box-shadow: 0 10px 15px -3px var(--accent-primary), 
                        0 4px 6px -2px var(--accent-primary) !important;
            opacity: 0.2;
        }

        /* Fix save button and primary buttons */
        #save-btn,
        .btn-primary {
            background: var(--accent-primary) !important;
            color: var(--text-on-accent) !important;
            opacity: 1 !important;
            font-weight: 700 !important;
            border: none !important;
        }

        #save-btn:hover,
        .btn-primary:hover {
            background: var(--accent-secondary) !important;
            color: var(--text-on-accent) !important;
            opacity: 1 !important;
            filter: brightness(1.1);
        }

        /* Fix toggle sidebar button */
        #toggle-sidebar-btn {
            background: var(--accent-primary) !important;
            color: var(--text-on-accent) !important;
            opacity: 1 !important;
            border: none !important;
        }

        #toggle-sidebar-btn svg {
            stroke: var(--text-on-accent) !important;
        }

        /* Fix icon colors in header */
        .icon-btn-header.bg-cyan-400 {
            background: var(--accent-primary) !important;
        }

        /* Fix active type buttons */
        #type-activity.active,
        #type-transport.active {
            background-color: var(--accent-primary) !important;
            color: #000 !important;
        }

        /* Fix day filter */
        .day-filter-styled {
            border-color: var(--border-color) !important;
            color: var(--text-main) !important;
        }

        /* Make sure inputs use theme colors */
        input, textarea, select {
            background: rgba(255,255,255,0.05) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-primary) !important;
            outline: none !important;
        }

        /* Fix logo icon */
        .header-glass .w-7.h-7.bg-cyan-400 {
            background: var(--accent-primary) !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            margin: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        h1, h2, .brand-font { font-family: 'Space Grotesk', sans-serif; }

        #map { 
            position: absolute;
            inset: 0;
            z-index: 1;
            background: #0b0b0b;
        }

        /* Sidebar Styling */
        #sidebar {
            position: fixed;
            z-index: 2000;
            background: var(--panel-bg);
            backdrop-filter: blur(25px);
            transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
            will-change: transform;
        }

        @media (max-width: 639px) {
            #sidebar { 
                bottom: 0; left: 0; right: 0; 
                height: 85vh; 
                border-radius: 28px 28px 0 0; 
                transform: translateY(100%); 
                padding-bottom: var(--safe-bottom);
            }
            #sidebar.open { transform: translateY(0); }
            
            #sidebar::before {
                content: '';
                width: 40px;
                height: 5px;
                background: rgba(255,255,255,0.2);
                border-radius: 10px;
                position: absolute;
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        @media (min-width: 640px) and (max-width: 1024px) {
            #sidebar { 
                top: 20px; 
                right: 20px; 
                bottom: 20px; 
                width: 280px; /* Schmaler f√ºr Tablets */
                border-radius: 24px; 
                transform: translateX(calc(100% + 40px)); 
                border: 1px solid var(--border-color); 
            }
            #sidebar.open { transform: translateX(0); }
        }

        @media (min-width: 1025px) {
            #sidebar { 
                top: 20px; 
                right: 20px; 
                bottom: 20px; 
                width: 380px; /* Original Breite */
                border-radius: 24px; 
                transform: translateX(calc(100% + 40px)); 
                border: 1px solid var(--border-color); 
            }
            #sidebar.open { transform: translateX(0); }
        }

        /* Form Elements */
        input, select, textarea {
            background: #1e1e1e !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 14px 16px !important;
            color: #ffffff !important;
            width: 100%;
            font-size: 16px;
            appearance: none;
            color-scheme: dark;
        }

        /* Spezifische Anpassung f√ºr den Filter in der Sidebar */
        #day-filter {
            background: #2a2a2a !important; /* Etwas heller f√ºr Kontrast zur Sidebar */
            padding: 8px 32px 8px 16px !important;
            font-size: 11px !important;
            border-radius: 50px !important;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 12px center !important;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
            cursor: pointer;
        }

        /* Header Control Bar */
        .top-header-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1050;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-glass {
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .icon-btn-header {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        /* Itinerary Cards */
        .itinerary-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            touch-action: none;
        }

        /* Modal / Form Overlay */
        #add-form-overlay {
            position: fixed;
            inset: 0;
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(12px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        #add-form-overlay.open { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: #141414;
            width: 92%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            border-radius: 32px;
            border: 1px solid var(--border-color);
        }

        .drag-handle {
            display: flex;
            align-items: center;
            padding: 0 16px 0 4px;
            color: rgba(255,255,255,0.3);
            cursor: grab;
            min-width: 44px;
        }

        /* Image Upload Styles */
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .delete-image-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-preview-item:hover .delete-image-btn {
            opacity: 1;
        }

        .image-preview-item .delete-image-btn:hover {
            background: rgba(220, 38, 38, 0.9);
        }

        .upload-button-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .upload-button-content:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent-primary);
            color: var(--text-main);
        }

        .point-thumbnail {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .point-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .point-images-indicator {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            align-items: center;
        }

        .more-images-badge {
            font-size: 10px;
            padding: 4px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .lightbox-nav {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 20px;
            color: white;
        }

        .lightbox-nav button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .lightbox-nav button:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
        }

        .lightbox-nav button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Time Block Styles */
        .time-block {
            transition: all 0.2s;
        }

        .time-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Responsive List Items */
        /* Mobile: Kompakt */
        @media (max-width: 639px) {
            .time-block {
                padding: 10px 12px !important;
                min-height: 50px;
            }
            
            /* Hide description and category badge on mobile */
            .time-block .point-desc,
            .time-block .category-badge {
                display: none !important;
            }
            
            /* Compact title and info layout */
            .time-block .point-title {
                font-size: 14px !important;
                margin-bottom: 4px !important;
            }
            
            .time-block .point-info {
                font-size: 11px !important;
            }
        }

        /* Tablet: Mittel */
        @media (min-width: 640px) and (max-width: 1024px) {
            .time-block {
                padding: 12px 14px !important;
                min-height: 55px;
            }
            
            /* Hide description and category badge on tablet */
            .time-block .point-desc,
            .time-block .category-badge {
                display: none !important;
            }
            
            .time-block .point-title {
                font-size: 14px !important;
                margin-bottom: 4px !important;
            }
            
            .time-block .point-info {
                font-size: 12px !important;
            }
        }

        /* Desktop: Voll (keine Einschr√§nkungen) */
        @media (min-width: 1025px) {
            .time-block {
                /* Original styles apply */
            }
        }

        /* More Menu System */
        .sidebar-actions-desktop {
            display: none;
        }

        .sidebar-actions-compact {
            display: flex;
            gap: 8px;
        }

        @media (min-width: 1025px) {
            .sidebar-actions-desktop {
                display: block;
            }
            
            .sidebar-actions-compact {
                display: none;
            }
        }

        /* More Menu Dropdown */
        #more-menu-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 -8px 24px rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
        }

        #more-menu-dropdown.hidden {
            display: none;
        }

        #more-menu-dropdown button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: transparent;
            border: none;
            color: var(--text-main);
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #more-menu-dropdown button:hover {
            background: rgba(255,255,255,0.05);
        }

        #more-menu-dropdown button:active {
            transform: scale(0.98);
        }

        /* Compact filter on mobile/tablet */
        @media (max-width: 1024px) {
            .filter-label-full {
                display: none;
            }
            
            .filter-toggle {
                min-width: 40px;
                justify-content: center;
            }
            
            #day-filter {
                font-size: 12px;
            }
        }

        /* Hide theme button in more menu on tablet (visible icon button exists) */
        @media (min-width: 640px) and (max-width: 1024px) {
            .theme-btn-mobile {
                display: none !important;
            }
        }

        /* Show theme button in more menu only on mobile */
        @media (max-width: 639px) {
            .theme-btn-mobile {
                display: flex !important;
            }
        }

        /* Map Marker Hover Popup */
        .marker-popup {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            min-width: 260px;
            max-width: 340px;
            /* min-height removed - calculated dynamically by JS */
            pointer-events: auto;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            cursor: default;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .marker-popup.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        /* Remove pseudo-element temporarily */
        /* .marker-popup::before removed */

        /* Ensure children contribute to height */
        .marker-popup > * {
            position: relative;
            z-index: 1;
        }

        .marker-popup * {
            box-sizing: border-box;
        }

        .marker-popup-content {
            position: relative;
            width: 100%;
            background: transparent;
            display: flex;
            flex-direction: column;
            flex: 1; /* Grow to fill parent */
        }

        .marker-popup.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        .marker-popup::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--panel-bg);
        }

        .marker-popup-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .marker-popup-icon {
            font-size: 20px;
            flex-shrink: 0;
            line-height: 1;
        }

        .marker-popup-title {
            font-size: 13px;
            font-weight: bold;
            color: var(--text-main);
            flex-grow: 1;
            word-break: break-word;
            line-height: 1.3;
        }

        .marker-popup-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .marker-popup-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .marker-popup-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        /* Image Carousel */
        .marker-popup-carousel {
            position: relative;
            margin-bottom: 8px;
        }

        .marker-popup-carousel-main {
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: transparent;
        }

        .marker-popup-carousel-main img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .marker-popup-carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            width: 100%;
            pointer-events: none;
        }

        .marker-popup-carousel-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
        }

        .marker-popup-carousel-btn:hover:not(:disabled) {
            background: rgba(0,0,0,0.9);
            border-color: rgba(255,255,255,0.4);
        }

        .marker-popup-carousel-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .marker-popup-carousel-counter {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Old grid view for no images / fallback */
        .marker-popup-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 4px;
            max-height: 120px;
            overflow: hidden;
        }

        .marker-popup-image {
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .marker-popup-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .marker-popup-more {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
        }

        /* Quick Actions */
        .marker-popup-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .marker-popup-action-btn {
            flex: 1;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: 1px solid var(--border-color);
        }

        .marker-popup-action-btn.edit {
            background: rgba(6, 182, 212, 0.1);
            color: var(--accent-primary);
        }

        .marker-popup-action-btn.edit:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent-primary);
        }

        .marker-popup-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .marker-popup-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .marker-popup-action-btn.view-photos {
            background: rgba(168, 85, 247, 0.1);
            color: #a855f7;
        }

        .marker-popup-action-btn.view-photos:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: #a855f7;
        }

        /* Must-See Toggle */
        .must-see-toggle {
            cursor: pointer;
            display: block;
        }

        .toggle-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .must-see-toggle input:checked + .toggle-button {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .toggle-emoji {
            font-size: 16px;
            transition: transform 0.2s;
        }

        .must-see-toggle input:checked + .toggle-button .toggle-emoji {
            transform: scale(1.2);
        }

        .toggle-label {
            font-size: 11px;
            font-weight: bold;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .must-see-toggle input:checked + .toggle-button .toggle-label {
            color: #ffd700;
        }

        .must-see-toggle:hover .toggle-button {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent-primary);
        }

        /* Category & Must-See Badges */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .must-see-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 7px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Filter Toggle */
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .filter-toggle.active {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
            color: #ffd700;
        }

        .filter-toggle:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent-primary);
        }

        /* ============================================ */
        /* TUTORIAL SYSTEM STYLES */
        /* ============================================ */

        /* Welcome Modal */
        .tutorial-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .tutorial-modal.hidden {
            display: none;
        }

        .tutorial-content {
            background: var(--panel-bg);
            border-radius: 24px;
            padding: 48px;
            max-width: 600px;
            width: 100%;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
        }

        .tutorial-header h1 {
            font-size: 32px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tutorial-header p {
            text-align: center;
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 32px;
        }

        .tutorial-features {
            display: grid;
            gap: 12px;
            margin: 32px 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
        }

        .feature-item:hover {
            background: rgba(255,255,255,0.05);
            border-color: var(--accent-primary);
        }

        .feature-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-card);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .feature-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-main);
        }

        .tutorial-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .btn-tutorial-primary {
            flex: 1;
            padding: 16px 24px;
            background: var(--gradient-primary);
            color: var(--text-on-accent);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-tutorial-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(6, 182, 212, 0.4);
        }

        .btn-tutorial-secondary {
            flex: 1;
            padding: 16px 24px;
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-tutorial-secondary:hover {
            background: rgba(255,255,255,0.08);
        }

        .tutorial-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        /* Spotlight Tour */
        #spotlight-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            pointer-events: none;
        }

        #spotlight-overlay.hidden {
            display: none;
        }

        /* Spotlight backdrop removed - using 4 panels instead */
        
        #spotlight-highlight {
            position: fixed;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10002;
            transition: all 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            
            /* Glowing border effect */
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.8),
                        0 0 20px rgba(6, 182, 212, 0.6),
                        0 0 40px rgba(6, 182, 212, 0.4);
        }
        
        /* Four panels to create cutout effect */
        .spotlight-panel {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10001;
            pointer-events: auto;
            transition: all 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        }
        
        #spotlight-panel-top {
            top: 0;
            left: 0;
            right: 0;
            /* Height set by JS */
        }
        
        #spotlight-panel-bottom {
            left: 0;
            right: 0;
            bottom: 0;
            /* Top set by JS */
        }
        
        #spotlight-panel-left {
            left: 0;
            /* Top, bottom, width set by JS */
        }
        
        #spotlight-panel-right {
            right: 0;
            /* Top, bottom, width set by JS */
        }

        #spotlight-tooltip {
            position: fixed;
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            z-index: 10002;
            pointer-events: auto;
            animation: slideUp 0.3s ease-out;
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        #tooltip-step {
            font-size: 11px;
            color: var(--accent-primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tooltip-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tooltip-close:hover {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
        }

        #tooltip-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        #tooltip-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .tooltip-actions {
            display: flex;
            gap: 12px;
        }

        .tooltip-actions button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tooltip-actions button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #btn-next {
            background: var(--gradient-primary);
            color: var(--text-on-accent);
            border: none;
        }

        #btn-next:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }

        #btn-prev {
            background: transparent;
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        #btn-prev:hover:not(:disabled) {
            background: rgba(255,255,255,0.05);
        }

        /* Floating Help Button */
        .floating-help-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: var(--text-on-accent);
            border: none;
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(6, 182, 212, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-help-button:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 32px rgba(6, 182, 212, 0.6);
        }

        #help-menu {
            position: fixed;
            bottom: 90px;
            right: 24px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 1000;
            min-width: 200px;
            animation: slideUp 0.2s ease-out;
        }

        #help-menu.hidden {
            display: none;
        }

        #help-menu button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: transparent;
            border: none;
            color: var(--text-main);
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #help-menu button:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .tutorial-content {
                padding: 32px 24px;
            }

            .tutorial-header h1 {
                font-size: 24px;
            }

            .tutorial-actions {
                flex-direction: column;
            }

            #spotlight-tooltip {
                max-width: calc(100vw - 40px);
                left: 20px !important;
                right: 20px !important;
                width: auto !important;
            }

            .floating-help-button {
                bottom: 80px;
                right: 20px;
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            #help-menu {
                bottom: 136px;
                right: 20px;
            }
        }
    </style>
</head>
<body>

    <!-- Welcome Tutorial Modal -->
    <div id="welcome-modal" class="tutorial-modal hidden">
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h1>üó∫Ô∏è Willkommen bei TripViz!</h1>
                <p>Plane deine Japan-Reise mit interaktiver Karte</p>
            </div>
            
            <div class="tutorial-features">
                <div class="feature-item">
                    <span class="feature-icon">üó∫Ô∏è</span>
                    <span class="feature-text">Interaktive Karte mit Marker</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üìç</span>
                    <span class="feature-text">Aktivit√§ten & Transport hinzuf√ºgen</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üí∞</span>
                    <span class="feature-text">Budget in JPY & EUR tracken</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üé®</span>
                    <span class="feature-text">8 verschiedene Farbschemata</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üë•</span>
                    <span class="feature-text">Zusammen planen & teilen</span>
                </div>
            </div>
            
            <div class="tutorial-actions">
                <button onclick="startTour()" class="btn-tutorial-primary">
                    üéì Tour starten
                </button>
                <button onclick="skipWelcome()" class="btn-tutorial-secondary">
                    Direkt loslegen
                </button>
            </div>
            
            <label class="tutorial-checkbox">
                <input type="checkbox" id="dont-show-again">
                <span>Nicht mehr anzeigen</span>
            </label>
        </div>
    </div>

    <!-- Spotlight Tour Overlay -->
    <div id="spotlight-overlay" class="hidden">
        <!-- Four panels create the darkened backdrop with a cutout -->
        <div id="spotlight-panel-top" class="spotlight-panel"></div>
        <div id="spotlight-panel-bottom" class="spotlight-panel"></div>
        <div id="spotlight-panel-left" class="spotlight-panel"></div>
        <div id="spotlight-panel-right" class="spotlight-panel"></div>
        
        <!-- Highlighted element border -->
        <div id="spotlight-highlight"></div>
        
        <!-- Tooltip -->
        <div id="spotlight-tooltip">
            <div class="tooltip-header">
                <span id="tooltip-step">Schritt 1 von 5</span>
                <button class="tooltip-close" onclick="closeTour()">√ó</button>
            </div>
            <h3 id="tooltip-title">Titel</h3>
            <p id="tooltip-text">Beschreibung</p>
            <div class="tooltip-actions">
                <button onclick="previousStep()" id="btn-prev">‚Üê Zur√ºck</button>
                <button onclick="nextStep()" id="btn-next">Weiter ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Floating Help Button -->
    <button id="help-button" class="floating-help-button" onclick="toggleHelpMenu()" title="Hilfe & Tipps">
        ?
    </button>

    <!-- Help Menu -->
    <div id="help-menu" class="hidden">
        <button onclick="startTour(); toggleHelpMenu();">
            <span>üìñ</span>
            <span>Tour neu starten</span>
        </button>
        <button onclick="window.open('https://github.com/yzed93/tripviz', '_blank'); toggleHelpMenu();">
            <span>üìö</span>
            <span>Dokumentation</span>
        </button>
        <button onclick="alert('Feedback-Formular hier!'); toggleHelpMenu();">
            <span>üìß</span>
            <span>Feedback senden</span>
        </button>
    </div>

    <!-- Collaborative Modal -->
    <div id="collaborative-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10001; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: var(--panel-bg); border-radius: 24px; max-width: 500px; width: 100%; padding: 32px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 900;">üë• Zusammen planen</h2>
                <button onclick="closeCollaborativeModal()" style="width: 32px; height: 32px; border-radius: 8px; background: rgba(255,255,255,0.05); border: none; color: rgba(255,255,255,0.5); font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            
            <div id="create-section">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Erstelle eine gemeinsame Session und teile die Trip-ID mit deinen Freunden.</p>
                <button onclick="createCollaborativeTrip()" style="width: 100%; padding: 16px; background: var(--gradient-primary); color: var(--text-on-accent); border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-bottom: 16px;">
                    üÜï Neue Session starten
                </button>
            </div>
            
            <div id="trip-id-section" style="display: none; margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Deine Trip-ID:</p>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <code id="trip-id-display" style="flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: monospace; color: var(--accent-primary);"></code>
                    <button onclick="copyTripId()" style="padding: 12px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; cursor: pointer; color: white;">üìã</button>
                </div>
            </div>
            
            <div id="join-section">
                <p style="color: var(--text-secondary); margin-bottom: 12px;">Oder tritt einer bestehenden Session bei:</p>
                <input type="text" id="join-trip-id" placeholder="Trip-ID eingeben" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 8px; color: white; margin-bottom: 12px;">
                <button onclick="joinCollaborativeTrip()" style="width: 100%; padding: 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border-color); border-radius: 12px; font-weight: 700; cursor: pointer;">
                    üîó Session beitreten
                </button>
            </div>
        </div>
    </div>

    <script>
        // UI Functions for Collaborative Modal
        function showCollaborativeModal() {
            document.getElementById('collaborative-modal').style.display = 'flex';
        }
        
        function closeCollaborativeModal() {
            document.getElementById('collaborative-modal').style.display = 'none';
        }
        
        function copyTripId() {
            const tripId = document.getElementById('trip-id-display').textContent;
            navigator.clipboard.writeText(tripId).then(() => {
                alert('üìã Trip-ID kopiert!');
            }).catch(() => {
                alert('‚ùå Kopieren fehlgeschlagen');
            });
        }
        
        // These will be overwritten by firebase-collaborative.js
        window.createCollaborativeTrip = function() {
            console.log('Waiting for Firebase to load...');
            alert('‚è≥ Firebase wird noch geladen. Bitte warte einen Moment.');
        };
        
        window.joinCollaborativeTrip = function() {
            console.log('Waiting for Firebase to load...');
            alert('‚è≥ Firebase wird noch geladen. Bitte warte einen Moment.');
        };
        
        // Export functions
        window.showCollaborativeModal = showCollaborativeModal;
        window.closeCollaborativeModal = closeCollaborativeModal;
        window.copyTripId = copyTripId;
        
        console.log('‚úÖ Collaborative UI loaded');
    </script>
        window.showCollaborativeModal = showCollaborativeModal;
        window.closeCollaborativeModal = closeCollaborativeModal;
        window.copyTripId = copyTripId;
        window.createCollaborativeTrip = createCollaborativeTrip;
        window.joinCollaborativeTrip = joinCollaborativeTrip;
    </script>


    <div id="map"></div>

    <div class="top-header-bar">
        <div class="header-glass px-3 py-2 flex items-center gap-2 hidden sm:flex">
            <div class="w-7 h-7 bg-cyan-400 rounded-lg flex items-center justify-center text-black">
                <img src="favicon.ico" alt="TripViz" style="width: 20px; height: 20px; image-rendering: crisp-edges;">
            </div>
            <span class="brand-font font-bold text-sm tracking-tight hidden lg:block">TripViz</span>
        </div>

        <div class="header-glass flex-grow flex items-center p-1 relative shadow-2xl">
            <input type="text" id="global-search" placeholder="Ziel suchen..." class="!bg-transparent !border-none !py-2 !px-4 text-sm w-full focus:ring-0">
            <div id="global-suggestions" class="suggestions-box hidden absolute top-full left-0 right-0 mt-2 bg-black/90 rounded-2xl border border-white/10 overflow-hidden z-[2000]"></div>
        </div>

        <button id="toggle-sidebar-btn" class="header-glass icon-btn-header bg-cyan-400 !text-black border-none shadow-lg shadow-cyan-400/20">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
    </div>

    <!-- Modal Formular -->
    <div id="add-form-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="form-title" class="brand-font font-bold text-white/50 uppercase tracking-widest text-[10px]">Eintrag bearbeiten</h3>
                <button id="close-form-btn" class="w-10 h-10 flex items-center justify-center bg-white/5 rounded-full text-white/40">‚úï</button>
            </div>
            
            <div class="space-y-5">
                <div class="flex p-1.5 bg-white/5 rounded-2xl">
                    <button id="type-activity" class="flex-1 py-3 text-[11px] font-bold rounded-xl transition-all">AKTIVIT√ÑT</button>
                    <button id="type-transport" class="flex-1 py-3 text-[11px] font-bold rounded-xl transition-all">TRANSPORT</button>
                </div>

                <div id="activity-group" class="relative">
                    <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Was / Wo</label>
                    <input type="text" id="point-title" placeholder="z.B. Shibuya Crossing">
                    <div id="point-suggestions" class="suggestions-box hidden absolute top-full left-0 right-0 bg-[#1a1a1a] border border-white/10 rounded-xl z-10"></div>
                </div>

                <!-- Category & Must-See (only for activities) -->
                <div id="activity-meta-section" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Kategorie</label>
                        <select id="point-category" class="!py-2">
                            <option value="">Keine Kategorie</option>
                            <option value="temple">‚õ©Ô∏è Tempel & Schreine</option>
                            <option value="food">üçú Essen & Restaurants</option>
                            <option value="hotel">üè® Unterkunft</option>
                            <option value="shopping">üõçÔ∏è Shopping</option>
                            <option value="nature">üå∏ Natur & Parks</option>
                            <option value="museum">üé® Museen & Kultur</option>
                            <option value="entertainment">üéÆ Entertainment</option>
                            <option value="landmark">üóº Sehensw√ºrdigkeiten</option>
                            <option value="onsen">‚ô®Ô∏è Onsen & Wellness</option>
                            <option value="nightlife">üåÉ Nachtleben</option>
                            <option value="other">üìç Sonstiges</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Must-See</label>
                        <label class="must-see-toggle">
                            <input type="checkbox" id="point-must-see" class="hidden">
                            <div class="toggle-button">
                                <span class="toggle-emoji">üê≠</span>
                                <span class="toggle-label">Muss sehen!</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Image Upload Section (only for activities) -->
                <div id="image-upload-section" class="hidden">
                    <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">
                        üì∏ Bilder <span id="image-count-label">(0/5)</span>
                    </label>
                    
                    <div id="image-preview-grid" class="image-preview-grid mb-3">
                        <!-- Image previews will be shown here -->
                    </div>
                    
                    <label class="image-upload-button">
                        <input 
                            type="file" 
                            id="image-input" 
                            accept="image/*" 
                            multiple 
                            class="hidden"
                        >
                        <div class="upload-button-content">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                            <span>Bilder hinzuf√ºgen</span>
                        </div>
                    </label>
                    
                    <div class="text-[10px] text-white/40 mt-2">
                        Bilder werden komprimiert (~200KB pro Bild). Free: Max 5 Bilder.
                    </div>
                </div>

                <div id="transport-group" class="hidden space-y-4">
                    <div class="relative">
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Von</label>
                        <input type="text" id="transport-start" placeholder="Start...">
                        <div id="start-suggestions" class="suggestions-box hidden absolute top-full left-0 right-0 bg-[#1a1a1a] border border-white/10 rounded-xl z-10"></div>
                    </div>
                    <div class="relative">
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Nach</label>
                        <input type="text" id="transport-end" placeholder="Ziel...">
                        <div id="end-suggestions" class="suggestions-box hidden absolute top-full left-0 right-0 bg-[#1a1a1a] border border-white/10 rounded-xl z-10"></div>
                    </div>
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Verkehrsmittel</label>
                        <select id="transport-method">
                            <option value="üöÜ Zug">üöÜ Shinkansen / Zug</option>
                            <option value="‚úàÔ∏è Flug">‚úàÔ∏è Flug</option>
                            <option value="üöå Bus">üöå Bus</option>
                            <option value="üöï Taxi">üöï Taxi</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Datum</label>
                        <input type="date" id="point-date">
                    </div>
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Uhrzeit</label>
                        <select id="point-time" class="!py-2">
                            <option value="">Keine Angabe</option>
                            <optgroup label="üåÖ Morgen">
                                <option value="06:00">06:00 Uhr</option>
                                <option value="07:00">07:00 Uhr</option>
                                <option value="08:00">08:00 Uhr</option>
                                <option value="09:00">09:00 Uhr</option>
                                <option value="10:00">10:00 Uhr</option>
                                <option value="11:00">11:00 Uhr</option>
                            </optgroup>
                            <optgroup label="‚òÄÔ∏è Mittag">
                                <option value="12:00">12:00 Uhr</option>
                                <option value="13:00">13:00 Uhr</option>
                                <option value="14:00">14:00 Uhr</option>
                                <option value="15:00">15:00 Uhr</option>
                                <option value="16:00">16:00 Uhr</option>
                            </optgroup>
                            <optgroup label="üåô Abend">
                                <option value="17:00">17:00 Uhr</option>
                                <option value="18:00">18:00 Uhr</option>
                                <option value="19:00">19:00 Uhr</option>
                                <option value="20:00">20:00 Uhr</option>
                                <option value="21:00">21:00 Uhr</option>
                                <option value="22:00">22:00 Uhr</option>
                                <option value="23:00">23:00 Uhr</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Budget (¬•)</label>
                        <input type="number" id="point-budget-jpy" placeholder="0" inputmode="numeric">
                    </div>
                    <div>
                        <label class="text-[10px] text-white/40 uppercase font-bold ml-1 mb-1 block">Budget (‚Ç¨)</label>
                        <input type="number" id="point-budget-eur" placeholder="0" step="0.01" inputmode="decimal">
                    </div>
                </div>

                <textarea id="point-desc" rows="3" placeholder="Notizen..."></textarea>

                <div class="flex gap-4 pt-4">
                    <button id="delete-btn" class="hidden w-14 h-14 rounded-2xl bg-rose-500/10 text-rose-500 border border-rose-500/20 flex items-center justify-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                    <button id="save-btn" class="flex-grow py-4 bg-cyan-400 text-black font-bold rounded-2xl uppercase text-[12px] tracking-widest shadow-lg shadow-cyan-400/20">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <aside id="sidebar">
        <div class="p-6 pt-10 flex-shrink-0">
            <h2 class="brand-font font-bold text-2xl mb-1">Reiseplan</h2>
            <div class="flex justify-between items-center mb-6">
                <div>
                    <span id="point-count" class="text-[11px] font-bold text-cyan-400 uppercase tracking-wider">0 Stopps</span>
                    <div id="total-jpy" class="text-white font-bold text-2xl mt-1">¬• 0</div>
                </div>
                <div class="text-right">
                    <div id="total-eur" class="text-white/40 text-[11px] font-bold uppercase">‚Ç¨ 0.00</div>
                    <div class="mt-2 flex gap-2 justify-end">
                        <select id="day-filter" class="day-filter-styled"></select>
                        <div class="filter-toggle" id="must-see-filter" onclick="toggleMustSeeFilter()">
                            <span>üê≠</span>
                            <span id="must-see-filter-label" class="filter-label-full">Must-See</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="itinerary-list" class="flex-grow overflow-y-auto px-6 pb-24"></div>
        
        <!-- Theme Switcher -->
        <div class="px-6 pb-4 border-t border-white/5 pt-4">
            <button onclick="toggleThemeSelector()" class="w-full py-3 px-4 bg-white/5 hover:bg-white/10 text-white/70 text-xs font-bold rounded-xl border border-white/10 transition-all active:scale-95 flex items-center justify-center gap-2">
                <span>üé®</span>
                <span>Farbschema</span>
                <span id="current-theme-name" class="text-cyan-400">Cyberpunk</span>
            </button>
        </div>
        
        <!-- Share & Export Controls -->
        <div class="px-6 pb-6 border-t border-white/5 pt-4" style="position: relative;">

            <!-- Desktop: All Buttons (> 1024px) -->
            <div class="sidebar-actions-desktop">
                <button onclick="showCollaborativeModal()" class="w-full py-3 px-4 mb-3 bg-gradient-to-r from-purple-500/10 to-pink-500/10 hover:from-purple-500/20 hover:to-pink-500/20 text-purple-400 text-xs font-bold rounded-xl border border-purple-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>üë•</span>
                    <span>Zusammen planen</span>
                    <span id="online-indicator-desktop" style="display: none; font-size: 10px;"></span>
                </button>
                <button onclick="openShareMenu()" class="w-full py-3 px-4 mb-3 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 hover:from-cyan-500/20 hover:to-blue-500/20 text-cyan-400 text-xs font-bold rounded-xl border border-cyan-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>üîó</span>
                    <span>Reise teilen</span>
                </button>
                <div class="flex gap-2 mb-3">
                    <button onclick="exportTripData()" class="flex-1 py-3 px-4 bg-white/5 hover:bg-white/10 text-white/70 text-xs font-bold rounded-xl border border-white/10 transition-all active:scale-95">
                        üì• Export
                    </button>
                    <label class="flex-1 py-3 px-4 bg-white/5 hover:bg-white/10 text-white/70 text-xs font-bold rounded-xl border border-white/10 transition-all cursor-pointer text-center active:scale-95">
                        üì§ Import
                        <input type="file" accept=".json" onchange="importData(this.files[0]); this.value='';" class="hidden">
                    </label>
                </div>
                <button onclick="showTripStats()" class="w-full py-3 px-4 mb-3 bg-white/5 hover:bg-white/10 text-white/70 text-xs font-bold rounded-xl border border-white/10 transition-all active:scale-95">
                    üìä Statistiken
                </button>
            </div>

            <!-- Tablet/Mobile: Compact Buttons (< 1024px) -->
            <div class="sidebar-actions-compact">
                <button onclick="toggleMoreMenu()" id="more-menu-btn" class="flex-1 py-3 px-4 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-bold rounded-xl border border-white/10 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <span>‚ãÆ</span>
                    <span>Mehr</span>
                </button>
                <button onclick="openThemeSelector()" class="py-3 px-4 bg-white/5 hover:bg-white/10 text-white/70 text-sm font-bold rounded-xl border border-white/10 transition-all active:scale-95 flex items-center justify-center" style="min-width: 48px;">
                    <span>üé®</span>
                </button>
            </div>

            <!-- More Menu Dropdown -->
            <div id="more-menu-dropdown" class="hidden">
                <button onclick="showCollaborativeModal(); closeMoreMenu();">
                    <span>üë•</span>
                    <span>Zusammen planen</span>
                    <span id="online-indicator-mobile" style="display: none; font-size: 10px; margin-left: auto;"></span>
                </button>
                <button onclick="openShareMenu(); closeMoreMenu();">
                    <span>üîó</span>
                    <span>Reise teilen</span>
                </button>
                <button onclick="exportTripData(); closeMoreMenu();">
                    <span>üì•</span>
                    <span>Export</span>
                </button>
                <button onclick="document.querySelector('#more-menu-dropdown + input').click(); closeMoreMenu();">
                    <span>üì§</span>
                    <span>Import</span>
                </button>
                <button onclick="showTripStats(); closeMoreMenu();">
                    <span>üìä</span>
                    <span>Statistiken</span>
                </button>
                <!-- Theme on mobile only (hidden on tablet via media query later) -->
                <button onclick="openThemeSelector(); closeMoreMenu();" class="theme-btn-mobile">
                    <span>üé®</span>
                    <span>Farbschema</span>
                    <span id="current-theme-name-mobile" class="text-cyan-400" style="margin-left: auto; font-size: 11px;"></span>
                </button>
            </div>
            
            <!-- Hidden file input for import via more menu -->
            <input type="file" accept=".json" onchange="importData(this.files[0]); this.value='';" class="hidden" style="display: none;">
        </div>
    </aside>

    <!-- Theme Selector Modal -->
    <div id="theme-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: var(--panel-bg); border-radius: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 32px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="brand-font" style="font-size: 24px; font-weight: 700;">üé® Farbschema w√§hlen</h2>
                <button onclick="closeThemeSelector()" style="width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: none; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px;">
                <!-- Cyberpunk Dark -->
                <button class="theme-option active" data-theme="cyberpunk" data-name="Cyberpunk" onclick="switchTheme('cyberpunk', 'Cyberpunk')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #00f2ff; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #ff2d55; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #3b82f6; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 4px;">Cyberpunk Dark</div>
                    <div style="display: inline-block; font-size: 10px; padding: 2px 8px; background: rgba(255,255,255,0.1); border-radius: 6px; margin-top: 4px;">Standard</div>
                </button>

                <!-- Sakura -->
                <button class="theme-option" data-theme="sakura" data-name="Sakura" onclick="switchTheme('sakura', 'Sakura')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #ffb7c5; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #ff69b4; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #db7093; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center;">Sakura üå∏</div>
                </button>

                <!-- Zen Garden -->
                <button class="theme-option" data-theme="zen" data-name="Zen Garden" onclick="switchTheme('zen', 'Zen Garden')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #86efac; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #34d399; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #10b981; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center;">Zen Garden üçÉ</div>
                </button>

                <!-- Tokyo Neon (PRO) -->
                <button class="theme-option pro-theme" data-theme="neon" data-name="Tokyo Neon" onclick="switchTheme('neon', 'Tokyo Neon')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #ff00ff; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #00ffff; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #ffff00; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 4px;">Tokyo Neon üåÉ</div>
                    <div style="display: inline-block; font-size: 10px; padding: 2px 8px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; font-weight: 700; border-radius: 6px;">PRO</div>
                </button>

                <!-- Fuji Sunset (PRO) -->
                <button class="theme-option pro-theme" data-theme="fuji" data-name="Fuji Sunset" onclick="switchTheme('fuji', 'Fuji Sunset')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #fb923c; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #f97316; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #dc2626; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 4px;">Fuji Sunset üóª</div>
                    <div style="display: inline-block; font-size: 10px; padding: 2px 8px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; font-weight: 700; border-radius: 6px;">PRO</div>
                </button>

                <!-- Ocean Blue -->
                <button class="theme-option" data-theme="ocean" data-name="Ocean Blue" onclick="switchTheme('ocean', 'Ocean Blue')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #3b82f6; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #60a5fa; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #0ea5e9; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center;">Ocean Blue üåä</div>
                </button>

                <!-- Matcha -->
                <button class="theme-option" data-theme="matcha" data-name="Matcha" onclick="switchTheme('matcha', 'Matcha')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #84cc16; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #65a30d; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #4d7c0f; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center;">Matcha üçµ</div>
                </button>

                <!-- Midnight Purple (PRO) -->
                <button class="theme-option pro-theme" data-theme="midnight" data-name="Midnight Purple" onclick="switchTheme('midnight', 'Midnight Purple')">
                    <div style="display: flex; gap: 4px; margin-bottom: 12px; height: 40px;">
                        <span style="flex: 1; border-radius: 8px; background: #a855f7; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #c084fc; transition: transform 0.2s;"></span>
                        <span style="flex: 1; border-radius: 8px; background: #e879f9; transition: transform 0.2s;"></span>
                    </div>
                    <div style="font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 4px;">Midnight Purple üåô</div>
                    <div style="display: inline-block; font-size: 10px; padding: 2px 8px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; font-weight: 700; border-radius: 6px;">PRO</div>
                </button>
            </div>

            <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); font-size: 13px; color: rgba(255,255,255,0.6);">
                <p>üí° <strong>Tipp:</strong> PRO Themes sind mit dem Pro-Plan verf√ºgbar.</p>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: var(--panel-bg); border-radius: 24px; max-width: 500px; width: 100%; padding: 32px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="brand-font" style="font-size: 24px; font-weight: 700;">üîó Reise teilen</h2>
                <button onclick="closeShareMenu()" style="width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: none; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s; font-size: 20px;">√ó</button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Copy Link -->
                <button onclick="copyShareLink()" class="w-full py-4 px-4 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 hover:from-cyan-500/20 hover:to-blue-500/20 text-cyan-400 text-sm font-bold rounded-xl border border-cyan-500/20 transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span style="font-size: 20px;">üîó</span>
                    <span>Link kopieren</span>
                </button>

                <!-- QR Code -->
                <button onclick="showQRCode()" class="w-full py-4 px-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 hover:from-purple-500/20 hover:to-pink-500/20 text-purple-400 text-sm font-bold rounded-xl border border-purple-500/20 transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span style="font-size: 20px;">üì±</span>
                    <span>QR-Code anzeigen</span>
                </button>

                <!-- Download as Image -->
                <button onclick="downloadAsImage()" class="w-full py-4 px-4 bg-gradient-to-r from-green-500/10 to-emerald-500/10 hover:from-green-500/20 hover:to-emerald-500/20 text-green-400 text-sm font-bold rounded-xl border border-green-500/20 transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span style="font-size: 20px;">üì∏</span>
                    <span>Als Bild exportieren</span>
                </button>
            </div>

            <!-- Share Link Display (hidden by default) -->
            <div id="share-link-display" class="hidden mt-4 p-4 bg-white/5 rounded-xl border border-white/10">
                <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 8px; font-weight: 600;">DEIN SHARE-LINK:</div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input id="share-link-input" type="text" readonly style="flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 12px; color: var(--accent-primary); font-size: 12px; font-family: monospace;" />
                    <button onclick="copyFromInput()" style="padding: 10px 16px; background: var(--accent-primary); color: #000; border: none; border-radius: 8px; font-weight: 700; font-size: 11px; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                        COPY
                    </button>
                </div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 8px;">
                    ‚ú® Link bleibt g√ºltig solange du ihn teilst
                </div>
            </div>

            <!-- QR Code Display (hidden by default) -->
            <div id="qr-code-display" class="hidden mt-4 p-4 bg-white/5 rounded-xl border border-white/10 flex flex-col items-center">
                <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 12px; font-weight: 600;">QR-CODE SCANNEN:</div>
                <div id="qr-code-container" style="background: white; padding: 16px; border-radius: 12px;"></div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 12px; text-align: center;">
                    üì± Mit Handy scannen zum √ñffnen
                </div>
            </div>
        </div>
    </div>

    <style>
        .theme-option {
            background: rgba(255,255,255,0.03);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            color: var(--text-main);
        }

        .theme-option:hover {
            background: rgba(255,255,255,0.05);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .theme-option.active {
            border-color: var(--accent-primary);
            background: rgba(0,242,255,0.05);
        }

        .theme-option:hover span {
            transform: scale(1.1);
        }

        #theme-modal.hidden {
            display: none !important;
        }

        #share-modal.hidden {
            display: none !important;
        }
    </style>

    <!-- LZ-String for compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- QRCode.js for QR generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        const CONFIG = {
            STADIA_KEY: "2831d4eb-094e-4752-a3c9-1ae9e9d65f94",
            STORAGE_KEY: 'tripviz_mobile_v3',
            JPY_EUR: 1 / 160.50,
            SEARCH_DEBOUNCE_MS: 1000 // Increased for Nominatim rate limiting (1 req/sec)
        };

        // Utility: Escape HTML to prevent XSS attacks
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // INDEXEDDB IMPLEMENTATION
        // ========================================
        
        // TripViz Database with IndexedDB
        class TripVizDB {
            constructor() {
                this.dbName = 'TripVizDB';
                this.version = 3; // Updated for images store
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Create trips store
                        if (!db.objectStoreNames.contains('trips')) {
                            const tripStore = db.createObjectStore('trips', { keyPath: 'id', autoIncrement: true });
                            tripStore.createIndex('created_at', 'created_at', { unique: false });
                        }

                        // Create points store
                        if (!db.objectStoreNames.contains('points')) {
                            const pointStore = db.createObjectStore('points', { keyPath: 'id' });
                            pointStore.createIndex('date', 'date', { unique: false });
                            pointStore.createIndex('type', 'type', { unique: false });
                        }

                        // Create settings store
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        // Create images store
                        if (!db.objectStoreNames.contains('images')) {
                            const imageStore = db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
                            imageStore.createIndex('point_id', 'point_id', { unique: false });
                            imageStore.createIndex('uploaded_at', 'uploaded_at', { unique: false });
                        }
                    };
                });
            }

            // CRUD operations for points
            async savePoints(points) {
                const tx = this.db.transaction(['points'], 'readwrite');
                const store = tx.objectStore('points');
                
                // Clear existing
                await store.clear();
                
                // Add all points
                for (const point of points) {
                    await store.add(point);
                }
                
                return new Promise((resolve, reject) => {
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            async getPoints() {
                const tx = this.db.transaction(['points'], 'readonly');
                const store = tx.objectStore('points');
                const request = store.getAll();

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async addPoint(point) {
                const tx = this.db.transaction(['points'], 'readwrite');
                const store = tx.objectStore('points');
                const request = store.add(point);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async updatePoint(point) {
                const tx = this.db.transaction(['points'], 'readwrite');
                const store = tx.objectStore('points');
                const request = store.put(point);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deletePoint(pointId) {
                const tx = this.db.transaction(['points'], 'readwrite');
                const store = tx.objectStore('points');
                const request = store.delete(pointId);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // Settings operations
            async saveSetting(key, value) {
                const tx = this.db.transaction(['settings'], 'readwrite');
                const store = tx.objectStore('settings');
                const request = store.put({ key, value });

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getSetting(key) {
                const tx = this.db.transaction(['settings'], 'readonly');
                const store = tx.objectStore('settings');
                const request = store.get(key);

                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result?.value);
                    request.onerror = () => reject(request.error);
                });
            }

            // Export all data
            async exportData() {
                const points = await this.getPoints();
                const theme = await this.getSetting('theme');
                
                return {
                    version: 1,
                    exportDate: new Date().toISOString(),
                    points: points,
                    settings: {
                        theme: theme || 'cyberpunk'
                    }
                };
            }

            // Import data
            async importData(data) {
                if (!data.points || !Array.isArray(data.points)) {
                    throw new Error('Invalid data format');
                }

                await this.savePoints(data.points);
                
                if (data.settings?.theme) {
                    await this.saveSetting('theme', data.settings.theme);
                }
            }

            // Get statistics
            async getStats() {
                const points = await this.getPoints();
                
                const activities = points.filter(p => p.type === 'activity');
                const transports = points.filter(p => p.type === 'transport');
                const totalBudget = points.reduce((sum, p) => sum + (p.budget || 0), 0);
                
                return {
                    totalPoints: points.length,
                    activities: activities.length,
                    transports: transports.length,
                    totalBudget: totalBudget,
                    avgBudgetPerPoint: points.length > 0 ? totalBudget / points.length : 0
                };
            }

            // IMAGE OPERATIONS
            compressImage(dataUrl, maxSize = 1024, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    
                    img.onerror = reject;
                    img.src = dataUrl;
                });
            }

            async addImage(pointId, imageFile) {
                // Check if images store exists
                if (!this.db.objectStoreNames.contains('images')) {
                    console.warn('Images store does not exist yet. Cannot add image.');
                    return null;
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            const compressed = await this.compressImage(e.target.result, 1024, 0.8);
                            const thumbnail = await this.compressImage(e.target.result, 200, 0.6);
                            
                            const image = {
                                point_id: pointId,
                                data: compressed,
                                thumbnail: thumbnail,
                                filename: imageFile.name,
                                size: imageFile.size,
                                type: imageFile.type,
                                uploaded_at: new Date().toISOString()
                            };
                            
                            const tx = this.db.transaction(['images'], 'readwrite');
                            const store = tx.objectStore('images');
                            const request = store.add(image);
                            
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => reject(reader.error);
                    reader.readAsDataURL(imageFile);
                });
            }

            async getImages(pointId) {
                // Check if images store exists
                if (!this.db.objectStoreNames.contains('images')) {
                    console.warn('‚ö†Ô∏è Images store fehlt. L√∂sung: F12 ‚Üí Application ‚Üí IndexedDB ‚Üí TripVizDB ‚Üí Delete, dann Seite neu laden.');
                    return [];
                }
                
                try {
                    const tx = this.db.transaction(['images'], 'readonly');
                    const store = tx.objectStore('images');
                    const index = store.index('point_id');
                    const request = index.getAll(pointId);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('getImages error:', error);
                    return [];
                }
            }

            async deleteImage(imageId) {
                // Check if images store exists
                if (!this.db.objectStoreNames.contains('images')) {
                    console.warn('Images store does not exist yet.');
                    return;
                }
                
                const tx = this.db.transaction(['images'], 'readwrite');
                const store = tx.objectStore('images');
                const request = store.delete(imageId);
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getImagesSize() {
                // Check if images store exists
                if (!this.db.objectStoreNames.contains('images')) {
                    return 0;
                }
                
                try {
                    const tx = this.db.transaction(['images'], 'readonly');
                    const store = tx.objectStore('images');
                    const request = store.getAll();
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            const images = request.result;
                            const totalSize = images.reduce((sum, img) => {
                                return sum + (img.data.length * 0.75);
                            }, 0);
                            resolve(totalSize);
                        };
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('getImagesSize error:', error);
                    return 0;
                }
            }

            async getImageCount() {
                // Check if images store exists
                if (!this.db.objectStoreNames.contains('images')) {
                    return 0;
                }
                
                try {
                    const tx = this.db.transaction(['images'], 'readonly');
                    const store = tx.objectStore('images');
                    const request = store.count();
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('getImageCount error:', error);
                    return 0;
                }
            }
        }

        // Hybrid Storage: localStorage fallback + migration
        class HybridStorage {
            constructor() {
                this.db = new TripVizDB();
                this.ready = false;
                this.useLocalStorage = false;
            }

            async init() {
                try {
                    await this.db.init();
                    this.ready = true;
                    this.useLocalStorage = false;
                    
                    // Auto-migrate from localStorage
                    await this.migrateFromLocalStorage();
                    
                    console.log('‚úÖ IndexedDB initialized');
                } catch (error) {
                    console.warn('‚ö†Ô∏è IndexedDB failed, using localStorage:', error);
                    this.useLocalStorage = true;
                    this.ready = true;
                }
            }

            async migrateFromLocalStorage() {
                const oldData = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (!oldData) return;

                try {
                    const points = JSON.parse(oldData);
                    if (Array.isArray(points) && points.length > 0) {
                        const existingPoints = await this.db.getPoints();
                        
                        // Only migrate if IndexedDB is empty
                        if (existingPoints.length === 0) {
                            console.log('üîÑ Migrating', points.length, 'points from localStorage to IndexedDB...');
                            await this.db.savePoints(points);
                            
                            // Keep localStorage as backup for now
                            console.log('‚úÖ Migration complete!');
                        }
                    }
                } catch (error) {
                    console.error('Migration failed:', error);
                }
            }

            async savePoints(points) {
                if (this.useLocalStorage) {
                    try {
                        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(points));
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            alert('‚ö†Ô∏è Speicher voll! Bitte exportiere deine Daten.');
                        }
                    }
                } else {
                    await this.db.savePoints(points);
                    // Also backup to localStorage
                    try {
                        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(points));
                    } catch (e) {
                        // Ignore localStorage errors when using IndexedDB
                    }
                }
            }

            async getPoints() {
                if (this.useLocalStorage) {
                    try {
                        const data = localStorage.getItem(CONFIG.STORAGE_KEY);
                        return data ? JSON.parse(data) : [];
                    } catch (e) {
                        console.error('LocalStorage read failed:', e);
                        return [];
                    }
                } else {
                    return await this.db.getPoints();
                }
            }

            async saveSetting(key, value) {
                if (this.useLocalStorage) {
                    localStorage.setItem(`setting_${key}`, JSON.stringify(value));
                } else {
                    await this.db.saveSetting(key, value);
                }
            }

            async getSetting(key) {
                if (this.useLocalStorage) {
                    const data = localStorage.getItem(`setting_${key}`);
                    return data ? JSON.parse(data) : null;
                } else {
                    return await this.db.getSetting(key);
                }
            }

            async exportData() {
                if (this.useLocalStorage) {
                    const points = await this.getPoints();
                    return {
                        version: 1,
                        exportDate: new Date().toISOString(),
                        points: points
                    };
                } else {
                    return await this.db.exportData();
                }
            }

            async importData(data) {
                if (this.useLocalStorage) {
                    if (!data.points || !Array.isArray(data.points)) {
                        throw new Error('Invalid data format');
                    }
                    await this.savePoints(data.points);
                } else {
                    await this.db.importData(data);
                }
            }

            async getStats() {
                if (this.useLocalStorage) {
                    const points = await this.getPoints();
                    const activities = points.filter(p => p.type === 'activity');
                    const transports = points.filter(p => p.type === 'transport');
                    const totalBudget = points.reduce((sum, p) => sum + (p.budget || 0), 0);
                    
                    return {
                        totalPoints: points.length,
                        activities: activities.length,
                        transports: transports.length,
                        totalBudget: totalBudget
                    };
                } else {
                    return await this.db.getStats();
                }
            }
        }

        // Global storage instance
        const storage = new HybridStorage();

        let state = {
            points: [],
            map: null,
            markers: [],
            paths: [],
            activityPaths: [],
            currentType: 'activity',
            editingId: null,
            tempCoords: { start: null, end: null },
            searchDebounce: null,
            sortables: [],
            uiState: { sidebar: false, modal: false },
            currentImages: [], // NEW: Images for current point
            mustSeeFilter: false // NEW: Must-See filter state
        };

        // IMAGE HANDLING FUNCTIONS
        async function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            const MAX_IMAGES = 5;
            
            if (state.currentImages.length + files.length > MAX_IMAGES) {
                alert(`‚ö†Ô∏è Maximal ${MAX_IMAGES} Bilder pro Aktivit√§t!\n\nüíé Mit Pro: Unbegrenzte Bilder`);
                return;
            }
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    alert('Nur Bilder erlaubt!');
                    continue;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    alert('Bild zu gro√ü! Max 10MB vor Kompression.');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.currentImages.push({
                        data: e.target.result,
                        filename: file.name,
                        file: file,
                        temp: true
                    });
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        }

        function renderImagePreview() {
            const container = document.getElementById('image-preview-grid');
            const label = document.getElementById('image-count-label');
            
            if (!container || !label) return;
            
            label.textContent = `(${state.currentImages.length}/5)`;
            
            container.innerHTML = state.currentImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img.thumbnail || img.data}" alt="${escapeHtml(img.filename)}">
                    <button class="delete-image-btn" onclick="removeImage(${index})" type="button">√ó</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            const img = state.currentImages[index];
            
            if (img.id && !img.temp) {
                if (confirm('Bild permanent l√∂schen?')) {
                    storage.db.deleteImage(img.id).catch(err => {
                        console.error('Delete failed:', err);
                    });
                } else {
                    return;
                }
            }
            
            state.currentImages.splice(index, 1);
            renderImagePreview();
        }

        function showLightbox(images, startIndex = 0) {
            let currentIndex = startIndex;
            
            const lightbox = document.createElement('div');
            lightbox.className = 'lightbox';
            lightbox.id = 'image-lightbox';
            
            function render() {
                lightbox.innerHTML = `
                    <div class="lightbox-content">
                        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
                        <img src="${images[currentIndex].data}" alt="" class="lightbox-image">
                        <div class="lightbox-nav">
                            <button 
                                ${currentIndex === 0 ? 'disabled' : ''} 
                                onclick="lightboxPrev()">
                                ‚Üê Zur√ºck
                            </button>
                            <span>${currentIndex + 1} / ${images.length}</span>
                            <button 
                                ${currentIndex === images.length - 1 ? 'disabled' : ''} 
                                onclick="lightboxNext()">
                                Weiter ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }
            
            window.lightboxPrev = () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    render();
                }
            };
            
            window.lightboxNext = () => {
                if (currentIndex < images.length - 1) {
                    currentIndex++;
                    render();
                }
            };
            
            window.closeLightbox = () => {
                lightbox.remove();
                delete window.lightboxPrev;
                delete window.lightboxNext;
                delete window.closeLightbox;
            };
            
            lightbox.onclick = (e) => {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            };
            
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeLightbox();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            render();
            document.body.appendChild(lightbox);
        }

        async function loadPointImages(pointId) {
            try {
                // Check if DB is ready and function exists
                if (!storage || !storage.db || typeof storage.db.getImages !== 'function') {
                    console.warn('Image functions not available yet');
                    return;
                }
                
                const images = await storage.db.getImages(pointId);
                if (images.length === 0) return;
                
                const container = document.querySelector(`[data-point-id="${pointId}"]`);
                if (!container) return;
                
                container.innerHTML = `
                    <div class="point-thumbnail" onclick="event.stopPropagation(); openPointLightbox(${pointId}, 0)">
                        <img src="${images[0].thumbnail || images[0].data}" alt="">
                    </div>
                    ${images.length > 1 ? `<span class="more-images-badge">+${images.length - 1}</span>` : ''}
                `;
            } catch (error) {
                console.error('Load images failed:', error);
            }
        }

        async function openPointLightbox(pointId, startIndex = 0) {
            try {
                // Check if DB is ready and function exists
                if (!storage || !storage.db || typeof storage.db.getImages !== 'function') {
                    console.warn('Image functions not available yet');
                    return;
                }
                
                const images = await storage.db.getImages(pointId);
                if (images.length > 0) {
                    showLightbox(images, startIndex);
                }
            } catch (error) {
                console.error('Open lightbox failed:', error);
            }
        }
        
        window.openPointLightbox = openPointLightbox;

        const el = {
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('add-form-overlay'),
            list: document.getElementById('itinerary-list'),
            filter: document.getElementById('day-filter')
        };

        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize storage first
            await storage.init();
            
            // Load points from storage
            state.points = await storage.getPoints();
            
            // Initialize theme
            const savedTheme = await storage.getSetting('theme') || localStorage.getItem('tripviz-theme') || 'cyberpunk';
            initTheme();
            if (savedTheme !== 'cyberpunk') {
                applyTheme(savedTheme);
                updateThemeUI(savedTheme);
            }
            
            // Initialize map and UI
            initMap();
            setupEventListeners();
            updateUI();
        });

        function toggleSidebar(force) {
            state.uiState.sidebar = (force !== undefined) ? force : !state.uiState.sidebar;
            el.sidebar.classList.toggle('open', state.uiState.sidebar);
        }

        async function openModal() {
            state.uiState.modal = true;
            el.overlay.classList.add('open');
            document.getElementById('delete-btn').classList.toggle('hidden', !state.editingId);
            
            // Load images if editing an activity
            if (state.editingId && state.currentType === 'activity') {
                try {
                    if (storage && storage.db && typeof storage.db.getImages === 'function') {
                        const images = await storage.db.getImages(state.editingId);
                        state.currentImages = images.map(img => ({
                            id: img.id,
                            data: img.data,
                            thumbnail: img.thumbnail,
                            filename: img.filename,
                            temp: false // Already saved
                        }));
                        renderImagePreview();
                    } else {
                        console.warn('Image functions not available yet');
                        state.currentImages = [];
                        renderImagePreview();
                    }
                } catch (error) {
                    console.error('Load images failed:', error);
                    state.currentImages = [];
                }
            } else {
                state.currentImages = [];
                renderImagePreview();
            }
        }

        function closeModal() {
            state.uiState.modal = false;
            el.overlay.classList.remove('open');
            state.editingId = null;
            state.tempCoords = { start: null, end: null };
            state.currentImages = []; // Clear images
            
            // Reset category and must-see
            document.getElementById('point-category').value = '';
            document.getElementById('point-must-see').checked = false;
        }

        function initMap() {
            state.map = L.map('map', { zoomControl: false, attributionControl: false, tap: true }).setView([35.6762, 139.6503], 6);
            L.tileLayer(`https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=${CONFIG.STADIA_KEY}`).addTo(state.map);
            
            // Hide popup when map moves or zooms
            state.map.on('movestart zoomstart', () => {
                hideMarkerPopup();
            });
            
            state.map.on('click', async e => {
                if(state.uiState.modal || state.uiState.sidebar) { 
                    state.uiState.sidebar = false;
                    state.uiState.modal = false;
                    el.sidebar.classList.remove('open');
                    el.overlay.classList.remove('open');
                    return; 
                }
                state.tempCoords.start = [e.latlng.lat, e.latlng.lng];
                setType('activity');
                openModal();
                
                // Reverse geocoding: Get address from coordinates
                const titleInput = document.getElementById('point-title');
                titleInput.placeholder = 'L√§dt Adresse...';
                
                try {
                    const res = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?lat=${e.latlng.lat}&lon=${e.latlng.lng}&format=json&zoom=18`,
                        { headers: { 'User-Agent': 'TripViz-Japan/1.0' } }
                    );
                    const data = await res.json();
                    if (data && data.display_name) {
                        const address = data.display_name.split(',').slice(0, 2).join(', ');
                        titleInput.value = escapeHtml(address.split(',')[0].trim());
                    }
                    titleInput.placeholder = 'z.B. Shibuya Crossing';
                } catch (err) {
                    console.error('Reverse geocoding failed:', err);
                    titleInput.placeholder = `Ort bei ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('toggle-sidebar-btn').onclick = (e) => { e.stopPropagation(); toggleSidebar(); };
            document.getElementById('close-form-btn').onclick = closeModal;
            document.getElementById('type-activity').onclick = () => setType('activity');
            document.getElementById('type-transport').onclick = () => setType('transport');
            document.getElementById('save-btn').onclick = saveEntry;
            document.getElementById('delete-btn').onclick = deleteEntry;
            document.getElementById('image-input').onchange = handleImageUpload;
            el.filter.onchange = updateUI;
            
            // Currency synchronization
            document.getElementById('point-budget-jpy').oninput = (e) => {
                const jpy = parseFloat(e.target.value) || 0;
                document.getElementById('point-budget-eur').value = (jpy * CONFIG.JPY_EUR).toFixed(2);
            };
            document.getElementById('point-budget-eur').oninput = (e) => {
                const eur = parseFloat(e.target.value) || 0;
                document.getElementById('point-budget-jpy').value = Math.round(eur / CONFIG.JPY_EUR);
            };

            const searchInputs = ['global-search', 'point-title', 'transport-start', 'transport-end'];
            searchInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', e => {
                    const type = id === 'global-search' ? 'global' : id === 'point-title' ? 'point' : id === 'transport-start' ? 'start' : 'end';
                    handleSearch(e.target.value, type);
                });
            });
        }

        function setType(t) {
            state.currentType = t;
            const isAct = t === 'activity';
            document.getElementById('activity-group').classList.toggle('hidden', !isAct);
            document.getElementById('activity-meta-section').classList.toggle('hidden', !isAct);
            document.getElementById('image-upload-section').classList.toggle('hidden', !isAct);
            document.getElementById('transport-group').classList.toggle('hidden', isAct);
            document.getElementById('type-activity').className = isAct ? "flex-1 py-3 text-[11px] font-bold rounded-xl bg-cyan-400 text-black shadow-lg" : "flex-1 py-3 text-[11px] font-bold rounded-xl text-white/30";
            document.getElementById('type-transport').className = !isAct ? "flex-1 py-3 text-[11px] font-bold rounded-xl bg-rose-500 text-white shadow-lg" : "flex-1 py-3 text-[11px] font-bold rounded-xl text-white/30";
        }

        function handleSearch(q, target) {
            clearTimeout(state.searchDebounce);
            const containerId = target === 'global' ? 'global-suggestions' : (target === 'point' ? 'point-suggestions' : (target === 'start' ? 'start-suggestions' : 'end-suggestions'));
            const container = document.getElementById(containerId);
            if(q.length < 3) { container.classList.add('hidden'); return; }
            state.searchDebounce = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=jp&limit=5`, {
                        headers: {
                            'User-Agent': 'TripViz-Japan/1.0'
                        }
                    });
                    const data = await res.json();
                    if(data.length === 0) { container.classList.add('hidden'); return; }
                    container.innerHTML = data.map(i => {
                        const displayName = escapeHtml(i.display_name.split(',').slice(0,2).join(','));
                        return `<div class="p-4 cursor-pointer border-b border-white/5 text-sm active:bg-white/10" data-name="${displayName}" data-lat="${i.lat}" data-lon="${i.lon}">${displayName}</div>`;
                    }).join('');
                    
                    // Add click handlers safely
                    container.querySelectorAll('div').forEach(div => {
                        div.onclick = () => selectLoc(target, div.dataset.name, parseFloat(div.dataset.lat), parseFloat(div.dataset.lon));
                    });
                    
                    container.classList.remove('hidden');
                } catch(err) { 
                    console.error('Search failed:', err);
                    container.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">Suche fehlgeschlagen</div>';
                }
            }, CONFIG.SEARCH_DEBOUNCE_MS);
        }

        window.selectLoc = (target, name, lat, lon) => {
            const coords = [lat, lon];
            if(target === 'global') {
                state.tempCoords.start = coords;
                document.getElementById('point-title').value = name.split(',')[0];
                setType('activity'); openModal();
            } else if(target === 'point' || target === 'start') {
                state.tempCoords.start = coords;
                document.getElementById(target === 'point' ? 'point-title' : 'transport-start').value = name.split(',')[0];
            } else if(target === 'end') {
                state.tempCoords.end = coords;
                document.getElementById('transport-end').value = name.split(',')[0];
            }
            document.querySelectorAll('.suggestions-box').forEach(b => b.classList.add('hidden'));
            state.map.flyTo(coords, 15);
        };

        async function saveEntry() {
            try {
                const data = {
                    id: state.editingId || Date.now(),
                    type: state.currentType,
                    date: document.getElementById('point-date').value,
                    time: document.getElementById('point-time').value || '',
                    budget: parseFloat(document.getElementById('point-budget-jpy').value) || 0,
                    budgetEur: parseFloat(document.getElementById('point-budget-eur').value) || 0,
                    desc: escapeHtml(document.getElementById('point-desc').value.trim()),
                    coords: state.tempCoords.start,
                    endCoords: state.tempCoords.end
                };
                
                if(state.currentType === 'activity') {
                    data.title = escapeHtml(document.getElementById('point-title').value.trim()) || "Unbenannter Ort";
                    data.category = document.getElementById('point-category').value || '';
                    data.mustSee = document.getElementById('point-must-see').checked;
                } else {
                    const method = document.getElementById('transport-method').value;
                    const start = escapeHtml(document.getElementById('transport-start').value.trim()) || "Start";
                    const end = escapeHtml(document.getElementById('transport-end').value.trim()) || "Ziel";
                    data.title = `${method}: ${start} ‚Üí ${end}`;
                }
                
                if(state.editingId) { 
                    state.points = state.points.map(p => p.id === state.editingId ? data : p);
                    
                    // Update in Firebase
                    if (window.isFirebaseEnabled && window.isFirebaseEnabled()) {
                        const point = state.points.find(p => p.id === state.editingId);
                        if (point) {
                            await updatePointInFirebase(point);
                        }
                    }
                } else { 
                    state.points.push(data);
                    
                    // Add to Firebase
                    if (window.isFirebaseEnabled && window.isFirebaseEnabled()) {
                        await addPointToFirebase(data);
                    }
                }
                
                await syncAndSave();
                
                // Save images for activities
                if (state.currentType === 'activity' && state.currentImages.length > 0) {
                    for (const img of state.currentImages) {
                        if (img.temp && img.file) {
                            try {
                                await storage.db.addImage(data.id, img.file);
                            } catch (error) {
                                console.error('Image save failed:', error);
                            }
                        }
                    }
                }
                
                closeModal();
            } catch (error) {
                console.error('Error saving entry:', error);
                alert('‚ùå Fehler beim Speichern: ' + error.message);
            }
        }

        function deleteEntry() { state.points = state.points.filter(p => p.id !== state.editingId); syncAndSave(); closeModal(); }
        async function syncAndSave() { 
            await storage.savePoints(state.points); 
            updateUI(); 
        }
        
        // Export/Import Functions
        async function exportData() {
            try {
                const data = await storage.exportData();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tripviz-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Export erfolgreich');
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export fehlgeschlagen: ' + error.message);
            }
        }
        
        async function importData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.points || !Array.isArray(data.points)) {
                        throw new Error('Ung√ºltiges Dateiformat');
                    }
                    
                    if (confirm(`${data.points.length} Eintr√§ge importieren?\n\n‚ö†Ô∏è Bestehende Daten werden √ºberschrieben!`)) {
                        await storage.importData(data);
                        state.points = await storage.getPoints();
                        
                        // Apply theme if included
                        if (data.settings?.theme) {
                            applyTheme(data.settings.theme);
                            updateThemeUI(data.settings.theme);
                        }
                        
                        updateUI();
                        alert(`‚úÖ ${data.points.length} Eintr√§ge erfolgreich importiert!`);
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    alert('Import fehlgeschlagen: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Show storage statistics
        async function showStats() {
            try {
                const stats = await storage.getStats();
                const storageType = storage.useLocalStorage ? 'LocalStorage' : 'IndexedDB';
                
                // Get image stats
                let imageInfo = '';
                if (!storage.useLocalStorage) {
                    try {
                        const imageCount = await storage.db.getImageCount();
                        const imageSize = await storage.db.getImagesSize();
                        const imageSizeMB = (imageSize / (1024 * 1024)).toFixed(2);
                        imageInfo = `\nüì∏ Bilder: ${imageCount} (${imageSizeMB} MB)`;
                    } catch (e) {
                        imageInfo = '\nüì∏ Bilder: Fehler beim Laden';
                    }
                }
                
                alert(`üìä TripViz Statistiken\n\n` +
                      `üíæ Speicher: ${storageType}\n` +
                      `üìç Stopps gesamt: ${stats.totalPoints}\n` +
                      `üéØ Aktivit√§ten: ${stats.activities}\n` +
                      `üöÜ Transport: ${stats.transports}\n` +
                      `üí∞ Gesamt-Budget: ¬•${stats.totalBudget.toLocaleString()}${imageInfo}`);
            } catch (error) {
                console.error('Stats failed:', error);
                alert('Statistiken konnten nicht geladen werden.');
            }
        }
        
        // Make functions available globally
        window.exportTripData = exportData;
        window.showTripStats = showStats;
        
        // ========================================
        // THEME MANAGEMENT
        // ========================================
        
        const PRO_THEMES = ['neon', 'fuji', 'midnight'];
        const THEME_NAMES = {
            'cyberpunk': 'Cyberpunk',
            'sakura': 'Sakura',
            'zen': 'Zen Garden',
            'neon': 'Tokyo Neon',
            'fuji': 'Fuji Sunset',
            'ocean': 'Ocean Blue',
            'matcha': 'Matcha',
            'midnight': 'Midnight Purple'
        };
        
        // Initialize theme on load
        function initTheme() {
            const savedTheme = localStorage.getItem('tripviz-theme') || 'cyberpunk';
            applyTheme(savedTheme);
            updateThemeUI(savedTheme);
        }
        
        function toggleThemeSelector() {
            const modal = document.getElementById('theme-modal');
            modal.classList.toggle('hidden');
        }
        
        function closeThemeSelector() {
            document.getElementById('theme-modal').classList.add('hidden');
        }
        
        async function switchTheme(theme, themeName) {
            // Check if Pro theme
            if (PRO_THEMES.includes(theme)) {
                // For now, show alert (later integrate with actual Pro check)
                if (!confirm(`${themeName} ist ein PRO Theme.\n\nM√∂chtest du es trotzdem ausprobieren? (Normalerweise nur f√ºr Pro-Nutzer verf√ºgbar)`)) {
                    return;
                }
            }
            
            applyTheme(theme);
            updateThemeUI(theme);
            
            // Save to both localStorage (backup) and IndexedDB
            localStorage.setItem('tripviz-theme', theme);
            await storage.saveSetting('theme', theme);
            
            // Close modal
            closeThemeSelector();
            
            // Update map colors
            updateMapColors();
        }
        
        function applyTheme(theme) {
            // Remove all theme classes
            document.documentElement.className = '';
            
            // Add new theme class
            if (theme !== 'cyberpunk') {
                document.documentElement.classList.add(`theme-${theme}`);
            }
        }
        
        function updateThemeUI(theme) {
            // Update active state in modal
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            
            // Update current theme name in both desktop and mobile
            const themeName = THEME_NAMES[theme] || 'Cyberpunk';
            const themeNameElements = ['current-theme-name', 'current-theme-name-mobile'];
            themeNameElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = themeName;
            });
        }
        
        function updateMapColors() {
            // Simply re-render the map with new colors
            renderMap();
        }
        
function updateUI() { renderList(); updateFilter(); renderMap(); }

        function updateFilter() {
            const dates = [...new Set(state.points.map(p => p.date))].sort();
            const current = el.filter.value;
            el.filter.innerHTML = '<option value="all">Alle Tage</option>' + dates.map(d => `<option value="${d}">${new Date(d).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'})}</option>`).join('');
            el.filter.value = current || 'all';
        }

        // Category emoji mapping
        function getCategoryEmoji(category) {
            const emojiMap = {
                temple: '‚õ©Ô∏è',
                food: 'üçú',
                hotel: 'üè®',
                shopping: 'üõçÔ∏è',
                nature: 'üå∏',
                museum: 'üé®',
                entertainment: 'üéÆ',
                landmark: 'üóº',
                onsen: '‚ô®Ô∏è',
                nightlife: 'üåÉ',
                other: 'üìç'
            };
            return emojiMap[category] || 'üìç';
        }

        // Category label mapping
        function getCategoryLabel(category) {
            const labelMap = {
                temple: 'Tempel',
                food: 'Essen',
                hotel: 'Hotel',
                shopping: 'Shopping',
                nature: 'Natur',
                museum: 'Museum',
                entertainment: 'Fun',
                landmark: 'Landmark',
                onsen: 'Onsen',
                nightlife: 'Nacht',
                other: 'Sonstiges'
            };
            return labelMap[category] || '';
        }

        // Toggle Must-See filter
        function toggleMustSeeFilter() {
            state.mustSeeFilter = !state.mustSeeFilter;
            const filterBtn = document.getElementById('must-see-filter');
            filterBtn.classList.toggle('active', state.mustSeeFilter);
            renderList();
        }
        
        // Make it global
        window.toggleMustSeeFilter = toggleMustSeeFilter;

        function renderList() {
            const filterVal = el.filter.value;
            let totalJPY = 0;
            const grouped = state.points.reduce((acc, p) => { 
                if(!acc[p.date]) acc[p.date] = []; 
                acc[p.date].push(p); 
                return acc; 
            }, {});
            
            el.list.innerHTML = '';
            
            Object.keys(grouped).sort().forEach(date => {
                const dayPoints = grouped[date];
                const daySum = dayPoints.reduce((s, p) => s + p.budget, 0);
                totalJPY += daySum;
                
                if(filterVal !== 'all' && date !== filterVal) return;
                
                const dayLabel = new Date(date).toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'});
                
                // Group points by time block
                const timeBlocks = {
                    morning: dayPoints.filter(p => {
                        if (!p.time) return false;
                        const hour = parseInt(p.time.split(':')[0]);
                        return hour >= 6 && hour < 12;
                    }),
                    afternoon: dayPoints.filter(p => {
                        if (!p.time) return false;
                        const hour = parseInt(p.time.split(':')[0]);
                        return hour >= 12 && hour < 17;
                    }),
                    evening: dayPoints.filter(p => {
                        if (!p.time) return false;
                        const hour = parseInt(p.time.split(':')[0]);
                        return hour >= 17 || hour < 6;
                    }),
                    noTime: dayPoints.filter(p => !p.time)
                };
                
                const groupDiv = document.createElement('div');
                groupDiv.className = "day-group mb-8";
                groupDiv.dataset.date = date;
                
                // Day header
                groupDiv.innerHTML = `
                    <div class="flex justify-between items-end mb-4 px-1">
                        <h4 class="text-[10px] font-black uppercase tracking-widest text-white/20">${dayLabel}</h4>
                        <span class="text-[10px] font-bold text-white/40">¬• ${daySum.toLocaleString()}</span>
                    </div>
                `;
                
                // Render time blocks
                const blocks = [
                    { key: 'morning', label: 'üåÖ Morgen', points: timeBlocks.morning, color: 'from-amber-500/10 to-orange-500/10' },
                    { key: 'afternoon', label: '‚òÄÔ∏è Mittag', points: timeBlocks.afternoon, color: 'from-yellow-500/10 to-amber-500/10' },
                    { key: 'evening', label: 'üåô Abend', points: timeBlocks.evening, color: 'from-indigo-500/10 to-purple-500/10' },
                    { key: 'noTime', label: '‚è∞ Keine Zeit', points: timeBlocks.noTime, color: 'from-white/5 to-white/5' }
                ];
                
                blocks.forEach(block => {
                    if (block.points.length === 0) return;
                    
                    const blockSum = block.points.reduce((s, p) => s + p.budget, 0);
                    
                    const blockDiv = document.createElement('div');
                    blockDiv.className = `time-block mb-4 bg-gradient-to-r ${block.color} rounded-xl border border-white/5`;
                    
                    blockDiv.innerHTML = `
                        <div class="flex justify-between items-center px-3 py-2 border-b border-white/5">
                            <span class="text-[10px] font-bold text-white/60">${block.label}</span>
                            <span class="text-[10px] font-bold text-white/40">¬• ${blockSum.toLocaleString()}</span>
                        </div>
                        <div class="sortable-list-${block.key} p-2"></div>
                    `;
                    
                    const listContainer = blockDiv.querySelector(`.sortable-list-${block.key}`);
                    
                    // Sort by time within block
                    let sortedPoints = [...block.points].sort((a, b) => {
                        if (!a.time && !b.time) return 0;
                        if (!a.time) return 1;
                        if (!b.time) return -1;
                        return a.time.localeCompare(b.time);
                    });
                    
                    // Apply must-see filter
                    if (state.mustSeeFilter) {
                        sortedPoints = sortedPoints.filter(p => p.mustSee === true);
                    }
                    
                    sortedPoints.forEach(p => {
                        const card = document.createElement('div');
                        card.className = "itinerary-card flex items-center mb-2";
                        card.dataset.id = p.id;
                        
                        // Build badges
                        let badges = '';
                        if (p.type === 'activity' && p.category) {
                            badges += `<span class="category-badge">${getCategoryEmoji(p.category)} ${getCategoryLabel(p.category)}</span>`;
                        }
                        if (p.mustSee) {
                            badges += `<span class="must-see-badge">üê≠</span>`;
                        }
                        
                        card.innerHTML = `
                            <div class="drag-handle">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="opacity-30">
                                    <circle cx="9" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/>
                                    <circle cx="15" cy="5" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="15" cy="19" r="1.5"/>
                                </svg>
                            </div>
                            <div class="flex-grow py-1" onclick="editEntryById(${p.id})">
                                <div class="flex justify-between items-start gap-3">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        ${p.time ? `<span class="text-[10px] font-bold text-white/40">${p.time}</span>` : ''}
                                        <p class="text-[13px] font-bold text-white/90 leading-tight">${escapeHtml(p.title)}</p>
                                        ${badges}
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[11px] font-bold text-cyan-400">¬•${p.budget.toLocaleString()}</p>
                                        ${p.budgetEur ? `<p class="text-[9px] text-white/30">‚Ç¨${p.budgetEur.toFixed(2)}</p>` : ''}
                                    </div>
                                </div>
                                ${p.desc ? `<p class="text-[10px] text-white/30 mt-1 line-clamp-1">${escapeHtml(p.desc)}</p>` : ''}
                                <div class="point-images-indicator" data-point-id="${p.id}">
                                    <!-- Images will be loaded here -->
                                </div>
                            </div>
                        `;
                        
                        listContainer.appendChild(card);
                        
                        // Load images for activity points
                        if (p.type === 'activity') {
                            loadPointImages(p.id);
                        }
                    });
                    
                    groupDiv.appendChild(blockDiv);
                });
                
                el.list.appendChild(groupDiv);
            });
            
            initSortable();
            document.getElementById('total-jpy').innerText = `¬• ${totalJPY.toLocaleString()}`;
            document.getElementById('total-eur').innerText = `‚Ç¨ ${(totalJPY * CONFIG.JPY_EUR).toLocaleString('de-DE', {minimumFractionDigits: 2})}`;
            document.getElementById('point-count').innerText = `${state.points.length} Stopps`;
        }

        // Load and display images for a point
        async function loadPointImages(pointId) {
            try {
                // Check if DB is ready and function exists
                if (!storage || !storage.db || typeof storage.db.getImages !== 'function') {
                    console.warn('Image functions not available yet');
                    return;
                }
                
                const images = await storage.db.getImages(pointId);
                if (images.length === 0) return;
                
                const container = document.querySelector(`[data-point-id="${pointId}"]`);
                if (!container) return;
                
                container.innerHTML = `
                    <div class="point-images-indicator">
                        <div class="point-thumbnail" onclick="event.stopPropagation(); openPointLightbox(${pointId}, 0)">
                            <img src="${images[0].thumbnail || images[0].data}" alt="">
                        </div>
                        ${images.length > 1 ? `<span class="more-images-badge">+${images.length - 1}</span>` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Load images failed:', error);
            }
        }

        // Open lightbox for point images
        async function openPointLightbox(pointId, startIndex = 0) {
            try {
                // Check if DB is ready and function exists
                if (!storage || !storage.db || typeof storage.db.getImages !== 'function') {
                    console.warn('Image functions not available yet');
                    return;
                }
                
                const images = await storage.db.getImages(pointId);
                if (images.length > 0) {
                    showLightbox(images, startIndex);
                }
            } catch (error) {
                console.error('Open lightbox failed:', error);
            }
        }
        
        // Make function available globally
        window.openPointLightbox = openPointLightbox;

        function initSortable() {
            state.sortables.forEach(s => s.destroy());
            state.sortables = [];
            document.querySelectorAll('.sortable-list').forEach(container => {
                const s = new Sortable(container, { group: 'itinerary', animation: 250, handle: '.drag-handle', onEnd: () => {
                    const newPoints = [];
                    document.querySelectorAll('.day-group').forEach(group => {
                        const date = group.dataset.date;
                        group.querySelectorAll('.itinerary-card').forEach(card => {
                            const p = state.points.find(x => x.id == card.dataset.id);
                            if(p) { p.date = date; newPoints.push(p); }
                        });
                    });
                    state.points = newPoints; syncAndSave();
                }});
                state.sortables.push(s);
            });
        }

        window.editEntryById = (id) => {
            const p = state.points.find(x => x.id === id);
            if(!p) return;
            state.editingId = p.id; state.currentType = p.type; state.tempCoords = { start: p.coords, end: p.endCoords };
            setType(p.type); openModal();
            if(p.type === 'activity') {
                document.getElementById('point-title').value = p.title;
                document.getElementById('point-category').value = p.category || '';
                document.getElementById('point-must-see').checked = p.mustSee || false;
            }
            else {
                const parts = p.title.split(': ')[1]?.split(' ‚Üí ') || ["", ""];
                document.getElementById('transport-start').value = parts[0]; document.getElementById('transport-end').value = parts[1];
            }
            document.getElementById('point-budget-jpy').value = p.budget || 0;
            document.getElementById('point-budget-eur').value = p.budgetEur || (p.budget * CONFIG.JPY_EUR).toFixed(2);
            document.getElementById('point-time').value = p.time || '';
            document.getElementById('point-desc').value = p.desc;
            document.getElementById('point-date').value = p.date;
            if(p.coords) state.map.flyTo(p.coords, 14);
        };

        function renderMap() {
            // Get current theme colors
            const root = getComputedStyle(document.documentElement);
            const primaryColor = root.getPropertyValue('--accent-primary').trim();
            const transportColor = root.getPropertyValue('--accent-transport').trim();
            const pathColor = root.getPropertyValue('--accent-path').trim();
            
            state.markers.forEach(m => state.map.removeLayer(m)); state.paths.forEach(p => state.map.removeLayer(p)); state.activityPaths.forEach(p => state.map.removeLayer(p));
            state.markers = []; state.paths = []; state.activityPaths = [];
            const filterVal = el.filter.value;
            const displayedPoints = filterVal === 'all' ? state.points : state.points.filter(p => p.date === filterVal);
            
            displayedPoints.forEach(p => {
                const color = p.type === 'activity' ? primaryColor : transportColor;
                
                if(p.coords) { 
                    const m = L.circleMarker(p.coords, { 
                        radius: 7, 
                        color: '#fff', 
                        weight: 2, 
                        fillColor: color, 
                        fillOpacity: 1 
                    }).addTo(state.map);
                    
                    // Add hover popup with delay to prevent flickering
                    m.on('mouseover', async (e) => {
                        // Clear any pending hide timeout
                        if (hidePopupTimeout) {
                            clearTimeout(hidePopupTimeout);
                            hidePopupTimeout = null;
                        }
                        await showMarkerPopup(p, e.target);
                    });
                    
                    m.on('mouseout', () => {
                        // Delay hiding to allow moving mouse to popup
                        hidePopupTimeout = setTimeout(() => {
                            hideMarkerPopup();
                        }, 200);
                    });
                    
                    state.markers.push(m); 
                }
                
                if(p.type === 'transport' && p.coords && p.endCoords) { 
                    const line = L.polyline.antPath([p.coords, p.endCoords], { 
                        color: color, 
                        weight: 4, 
                        pulseColor: '#fff', 
                        dashArray: [10, 20] 
                    }).addTo(state.map); 
                    state.paths.push(line); 
                }
            });
            
            if (filterVal !== 'all' && displayedPoints.length > 1) {
                const routeCoords = displayedPoints.map(p => p.coords).filter(c => c !== null);
                if (routeCoords.length > 1) { 
                    const activityLine = L.polyline(routeCoords, { 
                        color: pathColor, 
                        weight: 2, 
                        dashArray: '5, 10', 
                        opacity: 0.6, 
                        interactive: false 
                    }).addTo(state.map); 
                    state.activityPaths.push(activityLine); 
                }
            }
            
            if (displayedPoints.length > 0) { 
                const group = new L.featureGroup([...state.markers, ...state.paths, ...state.activityPaths]); 
                state.map.fitBounds(group.getBounds(), { padding: [80, 80] }); 
            }
        }

        // Marker Popup Functions
        let currentPopup = null;
        let currentCarouselIndex = 0;
        let currentCarouselImages = [];
        let hidePopupTimeout = null;

        // Feature 5: Custom Icons based on keywords
        function getPointIcon(title) {
            const titleLower = title.toLowerCase();
            
            // Temples & Shrines
            if (titleLower.includes('temple') || titleLower.includes('tempel') || titleLower.includes('shrine') || 
                titleLower.includes('schrein') || titleLower.includes('ji') || titleLower.includes('jinja')) {
                return '‚õ©Ô∏è';
            }
            
            // Food & Restaurants
            if (titleLower.includes('restaurant') || titleLower.includes('ramen') || titleLower.includes('sushi') ||
                titleLower.includes('essen') || titleLower.includes('food') || titleLower.includes('izakaya') ||
                titleLower.includes('caf√©') || titleLower.includes('coffee')) {
                return 'üçú';
            }
            
            // Hotels & Accommodation
            if (titleLower.includes('hotel') || titleLower.includes('hostel') || titleLower.includes('ryokan') ||
                titleLower.includes('unterkunft') || titleLower.includes('accommodation')) {
                return 'üè®';
            }
            
            // Shopping
            if (titleLower.includes('shop') || titleLower.includes('mall') || titleLower.includes('market') ||
                titleLower.includes('nakamise') || titleLower.includes('einkauf')) {
                return 'üõçÔ∏è';
            }
            
            // Parks & Nature
            if (titleLower.includes('park') || titleLower.includes('garden') || titleLower.includes('garten') ||
                titleLower.includes('nature') || titleLower.includes('natur')) {
                return 'üå∏';
            }
            
            // Museums & Culture
            if (titleLower.includes('museum') || titleLower.includes('gallery') || titleLower.includes('art') ||
                titleLower.includes('kunst') || titleLower.includes('kultur')) {
                return 'üé®';
            }
            
            // Entertainment
            if (titleLower.includes('karaoke') || titleLower.includes('game') || titleLower.includes('entertainment') ||
                titleLower.includes('arcade')) {
                return 'üéÆ';
            }
            
            // Landmarks & Towers
            if (titleLower.includes('tower') || titleLower.includes('turm') || titleLower.includes('crossing') ||
                titleLower.includes('skyline') || titleLower.includes('view')) {
                return 'üóº';
            }
            
            // Default
            return 'üìç';
        }

        async function showMarkerPopup(point, marker) {
            // Remove existing popup
            hideMarkerPopup();
            
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'marker-popup';
            popup.id = 'marker-popup';
            
            // Feature 5: Get custom icon
            const icon = getPointIcon(point.title);
            
            // Build badges for activities
            let badges = '';
            if (point.type === 'activity') {
                if (point.category) {
                    badges += `<span class="category-badge">${getCategoryEmoji(point.category)} ${getCategoryLabel(point.category)}</span>`;
                }
                if (point.mustSee) {
                    badges += `<span class="must-see-badge">üê≠ Must-See</span>`;
                }
            }
            
            // Build header with icon
            let content = `
                <div class="marker-popup-content">
                    <div class="marker-popup-header">
                        <div class="marker-popup-icon">${icon}</div>
                        <div class="marker-popup-title">${escapeHtml(point.title)}</div>
                    </div>
                    ${badges ? `<div class="marker-popup-badges">${badges}</div>` : ''}
            `;
            
            // Add info
            const infoParts = [];
            if (point.time) infoParts.push(`‚è∞ ${point.time}`);
            if (point.budget) infoParts.push(`¬•${point.budget.toLocaleString()}`);
            if (point.budgetEur) infoParts.push(`‚Ç¨${point.budgetEur.toFixed(2)}`);
            if (infoParts.length > 0) {
                content += `<div class="marker-popup-info">${infoParts.join(' ‚Ä¢ ')}</div>`;
            }
            
            // Feature 4: Show description
            if (point.desc && point.desc.trim()) {
                content += `<div class="marker-popup-desc">${escapeHtml(point.desc)}</div>`;
            }
            
            // Feature 2: Image Carousel for activities
            let images = [];
            if (point.type === 'activity') {
                try {
                    // Check if DB is ready and function exists
                    if (storage && storage.db && typeof storage.db.getImages === 'function') {
                        images = await storage.db.getImages(point.id);
                        if (images.length > 0) {
                            currentCarouselImages = images;
                            currentCarouselIndex = 0;
                            
                            content += `
                                <div class="marker-popup-carousel">
                                    <div class="marker-popup-carousel-main">
                                        <img src="${images[0].data}" alt="" id="carousel-image">
                                    </div>
                                    ${images.length > 1 ? `
                                        <div class="marker-popup-carousel-nav">
                                            <button class="marker-popup-carousel-btn" id="carousel-prev" ${currentCarouselIndex === 0 ? 'disabled' : ''}>‚Äπ</button>
                                            <button class="marker-popup-carousel-btn" id="carousel-next" ${currentCarouselIndex === images.length - 1 ? 'disabled' : ''}>‚Ä∫</button>
                                        </div>
                                        <div class="marker-popup-carousel-counter">
                                            <span id="carousel-counter">1 / ${images.length}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                    } else {
                        console.warn('Image functions not available yet');
                    }
                } catch (error) {
                    console.error('Failed to load images for popup:', error);
                }
            }
            
            // Feature 3: Quick Actions
            content += `
                <div class="marker-popup-actions">
                    <button class="marker-popup-action-btn edit" onclick="event.stopPropagation(); editEntryById(${point.id}); hideMarkerPopup();">
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    ${images.length > 0 ? `
                        <button class="marker-popup-action-btn view-photos" onclick="event.stopPropagation(); openPointLightbox(${point.id}, 0); hideMarkerPopup();">
                            üì∏ Fotos
                        </button>
                    ` : ''}
                    <button class="marker-popup-action-btn delete" onclick="event.stopPropagation(); deletePointFromPopup(${point.id});">
                        üóëÔ∏è
                    </button>
                </div>
                </div>
            `;
            
            popup.innerHTML = content;
            
            // Feature 1: Click to Edit (on background)
            popup.onclick = (e) => {
                if (e.target === popup || 
                    e.target.classList.contains('marker-popup-content') ||
                    e.target.classList.contains('marker-popup-header') || 
                    e.target.classList.contains('marker-popup-title') || 
                    e.target.classList.contains('marker-popup-info')) {
                    editEntryById(point.id);
                    hideMarkerPopup();
                }
            };
            
            // Get marker position on screen
            const markerPoint = state.map.latLngToContainerPoint(marker.getLatLng());
            popup.style.left = markerPoint.x + 'px';
            popup.style.top = markerPoint.y + 'px';
            
            // Add to map container
            const mapContainer = document.getElementById('map');
            mapContainer.appendChild(popup);
            
            // DYNAMIC HEIGHT CALCULATION
            // Wait for next frame so browser has calculated layout
            requestAnimationFrame(() => {
                const content = popup.querySelector('.marker-popup-content');
                if (content) {
                    const contentHeight = content.scrollHeight;
                    const paddingTop = 14;
                    const paddingBottom = 14;
                    const totalHeight = contentHeight + paddingTop + paddingBottom;
                    
                    // Set explicit height to ensure background covers everything
                    popup.style.minHeight = `${totalHeight}px`;
                    
                    console.log(`üìè Popup dynamic height: ${totalHeight}px (content: ${contentHeight}px)`);
                }
            });
            
            // Prevent popup from hiding when mouse is over it
            popup.onmouseenter = () => {
                if (hidePopupTimeout) {
                    clearTimeout(hidePopupTimeout);
                    hidePopupTimeout = null;
                }
            };
            
            popup.onmouseleave = () => {
                hidePopupTimeout = setTimeout(() => {
                    hideMarkerPopup();
                }, 200);
            };
            
            // Setup carousel navigation if images exist
            if (images.length > 1) {
                document.getElementById('carousel-prev').onclick = (e) => {
                    e.stopPropagation();
                    navigateCarousel(-1);
                };
                document.getElementById('carousel-next').onclick = (e) => {
                    e.stopPropagation();
                    navigateCarousel(1);
                };
            }
            
            // Trigger animation
            setTimeout(() => {
                popup.classList.add('visible');
            }, 10);
            
            currentPopup = popup;
        }

        // Feature 2: Carousel navigation
        function navigateCarousel(direction) {
            currentCarouselIndex += direction;
            currentCarouselIndex = Math.max(0, Math.min(currentCarouselIndex, currentCarouselImages.length - 1));
            
            // Update image
            const img = document.getElementById('carousel-image');
            if (img) {
                img.src = currentCarouselImages[currentCarouselIndex].data;
            }
            
            // Update counter
            const counter = document.getElementById('carousel-counter');
            if (counter) {
                counter.textContent = `${currentCarouselIndex + 1} / ${currentCarouselImages.length}`;
            }
            
            // Update button states
            const prevBtn = document.getElementById('carousel-prev');
            const nextBtn = document.getElementById('carousel-next');
            if (prevBtn) prevBtn.disabled = currentCarouselIndex === 0;
            if (nextBtn) nextBtn.disabled = currentCarouselIndex === currentCarouselImages.length - 1;
        }

        // Feature 3: Delete from popup
        function deletePointFromPopup(pointId) {
            if (confirm('Diesen Punkt wirklich l√∂schen?')) {
                state.points = state.points.filter(p => p.id !== pointId);
        // NEU: Delete from Firebase
            if (window.isFirebaseEnabled() && point && point.firebaseId) {
            deletePointFromFirebase(point.firebaseId);
    }
                syncAndSave();
                hideMarkerPopup();
            }
        }
        
        // Make it global
        window.deletePointFromPopup = deletePointFromPopup;

        function hideMarkerPopup() {
            // Clear any pending timeout
            if (hidePopupTimeout) {
                clearTimeout(hidePopupTimeout);
                hidePopupTimeout = null;
            }
            
            if (currentPopup) {
                currentPopup.classList.remove('visible');
                setTimeout(() => {
                    if (currentPopup && currentPopup.parentNode) {
                        currentPopup.parentNode.removeChild(currentPopup);
                    }
                    currentPopup = null;
                    // Reset carousel state
                    currentCarouselIndex = 0;
                    currentCarouselImages = [];
                }, 200);
            }
        }
        // ============================================
        // SHARE FUNCTIONS
        // ============================================

        function openShareMenu() {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // Enable flex layout when shown
            // Reset displays
            document.getElementById('share-link-display').classList.add('hidden');
            document.getElementById('qr-code-display').classList.add('hidden');
        }

        function closeShareMenu() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('hidden');
            modal.style.display = ''; // Remove inline display
        }

        function generateShareLink() {
            // Prepare data to share (exclude images for size)
            const shareData = state.points.map(p => ({
                id: p.id,
                type: p.type,
                title: p.title,
                date: p.date,
                time: p.time,
                budget: p.budget,
                budgetEur: p.budgetEur,
                desc: p.desc,
                coords: p.coords,
                endCoords: p.endCoords,
                category: p.category,
                mustSee: p.mustSee
            }));

            // Compress data
            const json = JSON.stringify(shareData);
            const compressed = LZString.compressToEncodedURIComponent(json);
            
            // Generate URL
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?trip=${compressed}`;
            
            return shareUrl;
        }

        async function copyShareLink() {
            const url = generateShareLink();
            
            try {
                await navigator.clipboard.writeText(url);
                
                // Show success feedback
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span style="font-size: 20px;">‚úÖ</span><span>Link kopiert!</span>';
                btn.style.background = 'linear-gradient(to right, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2))';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                }, 2000);
                
                // Also show in display
                document.getElementById('share-link-input').value = url;
                document.getElementById('share-link-display').classList.remove('hidden');
                
            } catch (err) {
                alert('Fehler beim Kopieren. Bitte manuell kopieren.');
                document.getElementById('share-link-input').value = url;
                document.getElementById('share-link-display').classList.remove('hidden');
            }
        }

        function copyFromInput() {
            const input = document.getElementById('share-link-input');
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            btn.textContent = '‚úì';
            setTimeout(() => btn.textContent = 'COPY', 1500);
        }

        let qrCodeInstance = null;

        function showQRCode() {
            const url = generateShareLink();
            const container = document.getElementById('qr-code-container');
            const display = document.getElementById('qr-code-display');
            
            // Clear previous QR code
            container.innerHTML = '';
            
            // Generate new QR code
            qrCodeInstance = new QRCode(container, {
                text: url,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            
            display.classList.remove('hidden');
            
            // Scroll to it
            display.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function downloadAsImage() {
            try {
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span style="font-size: 20px;">‚è≥</span><span>Wird erstellt...</span>';
                btn.disabled = true;
                
                // Close share modal temporarily
                closeShareMenu();
                
                // Wait a bit for modal to close
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Create export container
                const exportContainer = document.createElement('div');
                exportContainer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 1200px;
                    background: var(--panel-bg);
                    padding: 40px;
                    z-index: -9999;
                    font-family: system-ui, -apple-system, sans-serif;
                `;
                
                // Get trip stats
                const totalPoints = state.points.length;
                const totalBudget = state.points.reduce((sum, p) => sum + p.budget, 0);
                const days = [...new Set(state.points.map(p => p.date))].length;
                const mustSeeCount = state.points.filter(p => p.mustSee).length;
                
                // Group by date
                const grouped = state.points.reduce((acc, p) => { 
                    if(!acc[p.date]) acc[p.date] = []; 
                    acc[p.date].push(p); 
                    return acc; 
                }, {});
                
                // Build HTML for export
                let html = `
                    <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 24px; padding: 48px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 48px;">
                            <h1 style="font-size: 48px; font-weight: 900; background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 16px 0;">
                                üó∫Ô∏è Meine Japan Reise
                            </h1>
                            <div style="display: flex; gap: 32px; justify-content: center; margin-top: 24px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 32px; font-weight: 900; color: #06b6d4;">${totalPoints}</div>
                                    <div style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 600;">AKTIVIT√ÑTEN</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 32px; font-weight: 900; color: #06b6d4;">¬•${totalBudget.toLocaleString()}</div>
                                    <div style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 600;">GESAMT</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 32px; font-weight: 900; color: #06b6d4;">${days}</div>
                                    <div style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 600;">TAGE</div>
                                </div>
                                ${mustSeeCount > 0 ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 32px; font-weight: 900; color: #ffd700;">üê≠${mustSeeCount}</div>
                                    <div style="font-size: 14px; color: rgba(255,255,255,0.5); font-weight: 600;">MUST-SEE</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Activities by Day -->
                        <div style="display: grid; gap: 32px;">
                `;
                
                // Add each day
                Object.keys(grouped).sort().forEach((date, dayIndex) => {
                    const dayPoints = grouped[date];
                    const daySum = dayPoints.reduce((s, p) => s + p.budget, 0);
                    const dayLabel = new Date(date).toLocaleDateString('de-DE', {weekday:'long', day:'2-digit', month:'long'});
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid rgba(6, 182, 212, 0.3);">
                                <h3 style="font-size: 20px; font-weight: 900; color: #06b6d4; margin: 0; text-transform: uppercase; letter-spacing: 1px;">
                                    üìÖ ${dayLabel}
                                </h3>
                                <div style="font-size: 18px; font-weight: 900; color: rgba(255,255,255,0.9);">
                                    ¬•${daySum.toLocaleString()}
                                </div>
                            </div>
                            <div style="display: grid; gap: 12px;">
                    `;
                    
                    // Add points for this day
                    dayPoints.forEach(p => {
                        const icon = getCategoryEmoji(p.category || '');
                        const mustSeeBadge = p.mustSee ? '<span style="background: rgba(255, 215, 0, 0.2); border: 1px solid rgba(255, 215, 0, 0.3); padding: 2px 8px; border-radius: 6px; font-size: 14px; margin-left: 8px;">üê≠</span>' : '';
                        
                        html += `
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px;">
                                <div style="font-size: 32px; flex-shrink: 0;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        ${p.time ? `<span style="font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.4);">${p.time}</span>` : ''}
                                        <span style="font-size: 16px; font-weight: 900; color: rgba(255,255,255,0.95);">${escapeHtml(p.title)}</span>
                                        ${mustSeeBadge}
                                    </div>
                                    ${p.desc ? `<div style="font-size: 13px; color: rgba(255,255,255,0.5); line-height: 1.4;">${escapeHtml(p.desc).substring(0, 100)}${p.desc.length > 100 ? '...' : ''}</div>` : ''}
                                </div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    <div style="font-size: 18px; font-weight: 900; color: #06b6d4;">¬•${p.budget.toLocaleString()}</div>
                                    ${p.budgetEur ? `<div style="font-size: 12px; color: rgba(255,255,255,0.4);">‚Ç¨${p.budgetEur.toFixed(2)}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                // Footer
                html += `
                        </div>
                        
                        <!-- Footer -->
                        <div style="margin-top: 48px; text-align: center; padding-top: 32px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 14px; color: rgba(255,255,255,0.4); font-weight: 600;">
                                Erstellt mit TripViz üó∫Ô∏è
                            </div>
                        </div>
                    </div>
                `;
                
                exportContainer.innerHTML = html;
                document.body.appendChild(exportContainer);
                
                // Wait for fonts and styles to load
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Capture screenshot
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#0f172a',
                    scale: 2, // Higher quality
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });
                
                // Remove temp container
                document.body.removeChild(exportContainer);
                
                // Convert to blob and download
                canvas.toBlob(async (blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `japan-reise-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = url;
                    link.click();
                    
                    // Cleanup
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    
                    // Re-open share modal with success message
                    openShareMenu();
                    btn.innerHTML = '<span style="font-size: 20px;">‚úÖ</span><span>Bild heruntergeladen!</span>';
                    btn.style.background = 'linear-gradient(to right, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2))';
                    btn.disabled = false;
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = '';
                    }, 3000);
                });
                
            } catch (err) {
                console.error('Screenshot error:', err);
                alert('‚ùå Fehler beim Erstellen des Bildes. Bitte versuche es nochmal.');
                
                // Re-open modal
                openShareMenu();
                const btn = event.target.closest('button');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Check for shared trip on page load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tripData = urlParams.get('trip');
            
            if (tripData) {
                try {
                    // Decompress and parse
                    const json = LZString.decompressFromEncodedURIComponent(tripData);
                    const points = JSON.parse(json);
                    
                    if (Array.isArray(points) && points.length > 0) {
                        // Show confirmation
                        const confirm = window.confirm(
                            `üéâ Geteilte Reise gefunden!\n\n` +
                            `${points.length} Aktivit√§ten werden geladen.\n\n` +
                            `M√∂chtest du diese Reise √∂ffnen?`
                        );
                        
                        if (confirm) {
                            // Load shared trip
                            state.points = points;
                            syncAndSave();
                            
                            // Clean URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                            
                            alert('‚úÖ Reise erfolgreich geladen!');
                        }
                    }
                } catch (err) {
                    console.error('Failed to load shared trip:', err);
                    alert('‚ùå Fehler beim Laden der geteilten Reise.');
                }
            }
        });

        // Make functions global
        window.openShareMenu = openShareMenu;
        window.closeShareMenu = closeShareMenu;
        window.copyShareLink = copyShareLink;
        window.copyFromInput = copyFromInput;
        window.showQRCode = showQRCode;
        window.downloadAsImage = downloadAsImage;

        // ============================================
        // MORE MENU FUNCTIONS
        // ============================================
        
        function toggleMoreMenu() {
            const dropdown = document.getElementById('more-menu-dropdown');
            const btn = document.getElementById('more-menu-btn');
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                btn.style.background = 'rgba(255,255,255,0.1)';
            } else {
                dropdown.classList.add('hidden');
                btn.style.background = '';
            }
        }
        
        function closeMoreMenu() {
            const dropdown = document.getElementById('more-menu-dropdown');
            const btn = document.getElementById('more-menu-btn');
            dropdown.classList.add('hidden');
            btn.style.background = '';
        }
        
        // Close more menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('more-menu-dropdown');
            const btn = document.getElementById('more-menu-btn');
            
            if (dropdown && !dropdown.classList.contains('hidden')) {
                if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                    closeMoreMenu();
                }
            }
        });
        
        window.toggleMoreMenu = toggleMoreMenu;
        window.closeMoreMenu = closeMoreMenu;

        // ============================================
        // TUTORIAL SYSTEM
        // ============================================

        // Tutorial Configuration
        const TUTORIAL_STEPS = [
            {
                target: '#global-search',
                title: 'üîç Ziele suchen',
                text: 'Suche nach Orten wie "Shibuya", "Tokyo Tower" oder "Senso-ji". Klicke auf ein Ergebnis um es zur Karte hinzuzuf√ºgen.',
                position: 'bottom'
            },
            {
                target: '#map',
                title: 'üó∫Ô∏è Interaktive Karte',
                text: 'Klicke auf die Karte um eine neue Aktivit√§t hinzuzuf√ºgen. Ziehe Marker um Positionen anzupassen.',
                position: 'left'
            },
            {
                target: '#sidebar',
                title: 'üìã Dein Reiseplan',
                text: 'Hier siehst du alle deine Aktivit√§ten sortiert nach Datum. Klicke auf einen Eintrag um Details zu bearbeiten.',
                position: 'left'
            },
            {
                target: '#must-see-filter',
                title: 'üê≠ Must-See Filter',
                text: 'Markiere wichtige Orte als "Must-See" und filtere sie sp√§ter mit einem Klick.',
                position: 'bottom'
            },
            {
                target: window.innerWidth > 1024 ? '.sidebar-actions-desktop' : '#more-menu-btn',
                title: '‚ú® Mehr Features',
                text: 'Hier findest du zus√§tzliche Funktionen: Zusammen planen, Teilen, Export/Import und Statistiken.',
                position: 'top'
            }
        ];

        let currentStep = 0;
        let tourActive = false;

        // Check if first visit
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('tripviz-visited');
            const dontShowAgain = localStorage.getItem('tripviz-tutorial-skip');
            
            if (!hasVisited && !dontShowAgain) {
                // Show welcome modal after 500ms delay
                setTimeout(() => {
                    showWelcomeModal();
                }, 500);
            }
            
            localStorage.setItem('tripviz-visited', 'true');
        }

        // Welcome Modal Functions
        function showWelcomeModal() {
            document.getElementById('welcome-modal').classList.remove('hidden');
        }

        function skipWelcome() {
            const dontShow = document.getElementById('dont-show-again').checked;
            if (dontShow) {
                localStorage.setItem('tripviz-tutorial-skip', 'true');
            }
            document.getElementById('welcome-modal').classList.add('hidden');
        }

        // Start Tour
        function startTour() {
            skipWelcome();
            tourActive = true;
            currentStep = 0;
            
            // Open sidebar if closed
            if (!state.uiState.sidebar) {
                document.getElementById('toggle-sidebar-btn').click();
            }
            
            document.getElementById('spotlight-overlay').classList.remove('hidden');
            showStep(0);
        }

        // Show Tour Step
        function showStep(stepIndex) {
            if (stepIndex < 0 || stepIndex >= TUTORIAL_STEPS.length) return;
            
            currentStep = stepIndex;
            const step = TUTORIAL_STEPS[stepIndex];
            const target = document.querySelector(step.target);
            
            if (!target) {
                console.error('Tutorial target not found:', step.target);
                // Try next step
                if (stepIndex < TUTORIAL_STEPS.length - 1) {
                    setTimeout(() => showStep(stepIndex + 1), 100);
                }
                return;
            }
            
            // Update tooltip content
            document.getElementById('tooltip-step').textContent = `Schritt ${stepIndex + 1} von ${TUTORIAL_STEPS.length}`;
            document.getElementById('tooltip-title').textContent = step.title;
            document.getElementById('tooltip-text').textContent = step.text;
            
            // Update button states
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');
            
            btnPrev.disabled = stepIndex === 0;
            btnNext.textContent = stepIndex === TUTORIAL_STEPS.length - 1 ? 'Fertig ‚úì' : 'Weiter ‚Üí';
            
            // Highlight target element
            highlightElement(target);
            
            // Position tooltip
            positionTooltip(target, step.position);
        }

        function highlightElement(element) {
            const rect = element.getBoundingClientRect();
            const highlight = document.getElementById('spotlight-highlight');
            
            const padding = 8;
            
            // Position the highlight border
            const top = rect.top - padding;
            const left = rect.left - padding;
            const width = rect.width + padding * 2;
            const height = rect.height + padding * 2;
            
            highlight.style.top = top + 'px';
            highlight.style.left = left + 'px';
            highlight.style.width = width + 'px';
            highlight.style.height = height + 'px';
            
            // Position the 4 backdrop panels to create cutout
            const panelTop = document.getElementById('spotlight-panel-top');
            const panelBottom = document.getElementById('spotlight-panel-bottom');
            const panelLeft = document.getElementById('spotlight-panel-left');
            const panelRight = document.getElementById('spotlight-panel-right');
            
            // Top panel: from screen top to highlight top
            panelTop.style.height = top + 'px';
            
            // Bottom panel: from highlight bottom to screen bottom
            panelBottom.style.top = (top + height) + 'px';
            
            // Left panel: from highlight top to bottom, screen left to highlight left
            panelLeft.style.top = top + 'px';
            panelLeft.style.height = height + 'px';
            panelLeft.style.width = left + 'px';
            
            // Right panel: from highlight top to bottom, highlight right to screen right
            panelRight.style.top = top + 'px';
            panelRight.style.height = height + 'px';
            panelRight.style.left = (left + width) + 'px';
        }

        function positionTooltip(target, position) {
            const tooltip = document.getElementById('spotlight-tooltip');
            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let top, left;
            
            switch (position) {
                case 'bottom':
                    top = rect.bottom + 20;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    break;
                case 'top':
                    top = rect.top - tooltipRect.height - 20;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    break;
                case 'left':
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    left = rect.left - tooltipRect.width - 20;
                    break;
                case 'right':
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    left = rect.right + 20;
                    break;
                default:
                    top = rect.bottom + 20;
                    left = rect.left;
            }
            
            // Keep tooltip on screen
            const margin = 20;
            top = Math.max(margin, Math.min(top, window.innerHeight - tooltipRect.height - margin));
            left = Math.max(margin, Math.min(left, window.innerWidth - tooltipRect.width - margin));
            
            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        function nextStep() {
            if (currentStep < TUTORIAL_STEPS.length - 1) {
                showStep(currentStep + 1);
            } else {
                closeTour();
                // Celebrate!
                console.log('üéâ Tutorial completed!');
                localStorage.setItem('tripviz-tutorial-completed', 'true');
            }
        }

        function previousStep() {
            if (currentStep > 0) {
                showStep(currentStep - 1);
            }
        }

        function closeTour() {
            tourActive = false;
            document.getElementById('spotlight-overlay').classList.add('hidden');
        }

        // Help Menu Functions
        function toggleHelpMenu() {
            const menu = document.getElementById('help-menu');
            menu.classList.toggle('hidden');
        }

        // Close help menu when clicking outside
        document.addEventListener('click', (e) => {
            const helpBtn = document.getElementById('help-button');
            const helpMenu = document.getElementById('help-menu');
            
            if (helpMenu && !helpMenu.classList.contains('hidden')) {
                if (!helpMenu.contains(e.target) && !helpBtn.contains(e.target)) {
                    helpMenu.classList.add('hidden');
                }
            }
        });

        // Re-position elements on resize
        window.addEventListener('resize', () => {
            if (tourActive && currentStep >= 0) {
                const step = TUTORIAL_STEPS[currentStep];
                const target = document.querySelector(step.target);
                if (target) {
                    highlightElement(target);
                    positionTooltip(target, step.position);
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!tourActive) return;
            
            if (e.key === 'Escape') {
                closeTour();
            } else if (e.key === 'ArrowRight' || e.key === 'Enter') {
                nextStep();
            } else if (e.key === 'ArrowLeft') {
                previousStep();
            }
        });

        // Export functions
        window.checkFirstVisit = checkFirstVisit;
        window.showWelcomeModal = showWelcomeModal;
        window.skipWelcome = skipWelcome;
        window.startTour = startTour;
        window.showStep = showStep;
        window.nextStep = nextStep;
        window.previousStep = previousStep;
        window.closeTour = closeTour;
        window.toggleHelpMenu = toggleHelpMenu;

        // Initialize tutorial on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Small delay to ensure everything is loaded
            setTimeout(() => {
                checkFirstVisit();
            }, 300);
        });

    </script>
    

    <!-- Firebase Collaborative Module (EXTERNAL) -->
    <script src="firebase-collaborative.js"></script>

</body>
</html>

